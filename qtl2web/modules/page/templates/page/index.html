{% extends 'layouts/base.html' %}
{% block title %}{{ config.MAIN_TITLE|safe }}{% endblock %}
{% block meta_description %}{% endblock %}
{% block head %}
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css"/>

    <link rel="stylesheet"
          href="//cdn.jsdelivr.net/npm/bootstrap-select@1.13.7/dist/css/bootstrap-select.min.css"/>

    <link rel="stylesheet"
          href="//cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>

    <link rel="stylesheet"
          href="//cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css"/>

    <link rel="stylesheet"
          href="//unpkg.com/@genome-spy/core@0.19.0/dist/style.css"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/please-wait-0.0.5/please-wait.css') }}"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/dynatables-0.3.1/jquery.dynatable.css')}}"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/bootstrap-multiselect-0.9.15/dist/css/bootstrap-multiselect.css') }}"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='styles/main.css') }}"/>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D1707LSMF4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D1707LSMF4');
    </script>

    <style>
    <!--
        body {
            /*font-family: 'Roboto', sans-serif !important;*/
            /*font-family: IBM Plex Sans, sans-serif !important;*/
            font-family: system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
        }

        .genome-spy .tooltip {
            opacity: 100;
        }

        .snpMenuIcon a:hover {
            background: #3374C2;
        }

.modal.modal-fullscreen .modal-dialog {
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
  max-width: none;
}

.modal.modal-fullscreen .modal-content {
  height: auto;
  height: 100vh;
  border-radius: 0;
  border: none;
}

.modal.modal-fullscreen .modal-body {
  overflow-y: auto;
}

    //-->
    </style>
{% endblock %}
{% block body %}
<body>
<div class="inner">

    <nav id="dataSetSelectMenu" class="navbar navbar-expand-sm bg-dark navbar-dark fixed-top">
        <a class="navbar-brand" href="#">{{ config.NAV_TITLE|safe }}</a>
        <!-- will be filled in programatically //-->

    </nav>

    <div class="container-fluid">

        <main class="col-12" role="main">
            <div class="row">

                <div class="col-md-6 col-lg-5 col-xl-4">

                    <div class="row">
                        <div class="col">

                            <!-- Gene/Protein/Pheno selection //-->
                            <div class="card h-100">
                                <div class="card-header">
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a id="navPheno"
                                               class="nav-link"
                                               data-toggle="tab"
                                               href="#tabSearchPheno"><i class="fab fa-searchengin"></i> {{ config.TAB_SEARCH_PHENOTYPE_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a id="navGene"
                                               class="nav-link"
                                               data-toggle="tab"
                                               href="#tabSearchGene"><i class="fas fa-search"></i> {{ config.TAB_SEARCH_MRNA_PROTEIN_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a id="navLodPeaks"
                                               class="nav-link"
                                               data-toggle="tab"
                                               href="#tabLodPeaks"><i class="fas fa-th"></i> {{ config.TAB_LOD_PEAKS_TEXT|safe }}</a>
                                        </li>
                                    </ul>
                                </div>

                                <div class="card-body">
                                    <div class="tab-content">
                                        <div class="tab-pane h-100" role="tabpanel" id="tabSearchPheno">

                                            <div class="row">
                                                <div class="col" id="searchPheno">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col" id="searchPhenoCategoryText">
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col" id="searchPhenoCategory">
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div class="py-0" id="searchPhenoResultsInfo">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col results-wrapper">
                                                    <div id="searchPhenoResultsDiv"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane h-100" role="tabpanel" id="tabSearchGene">
                                            <div class="row">
                                                <div class="col">
                                                    <div class="input-group">
                                                        <input type="text" id="searchTerm" name="searchTerm" class="form-control" placeholder="{{ config.SEARCH_BOX_TEXT|safe }}">
                                                        <span class="input-group-append">
                                                            <button id="btnGo" class="btn btn-primary"><i class="fas fa-search"></i></button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div class="py-2" id="searchResultsTableInfo"></div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div id="searchResultsDiv"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane h-100" role="tabpanel" id="tabLodPeaks">

                                            <div class="row">
                                                <div class="col">
                                                    <div id="divInteractiveCovariatesPeaks"></div>
                                                </div>
                                            </div>
                                            <div class="row" id="divLODPeaksMenu"></div>
                                            <div class="row">
                                                <div class="col">
                                                    <div id="divLODPeaks"></div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- end Gene/Protein/Pheno selection //-->

                        </div>
                    </div>

                    <div class="row row-spacer"></div>

                    <div class="row invisible" id="divProfileCorrelation">
                        <div class="col">

                            <div class="card h-100">
                                <div class="card-header" id="profilePlot">
                                    <ul id="infoTabs" class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="navProfile" data-toggle="tab" href="#tabProfile"><i class="fas fa-calculator"></i> {{ config.TAB_PROFILE_PLOT_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="navCorrelation" data-toggle="tab" href="#tabCorrelation"><i class="fa-brands fa-uncharted"></i> {{ config.TAB_CORRELATION_TEXT|safe }}</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">

                                    <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="tabProfile">

                                            <div class="row" id="divProfilePlotOptions">

                                            </div>

                                            <div class="row" id="fact-svg-panel">
                                                <div class="col">
                                                    <div id="profilePlotChart"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane" id="tabCorrelation">
                                            <div class="row">
                                                <div class="col font-weight-bold">
                                                    <span class="align-bottom">{{ config.CORRELATION_SELECT_DATASET_TEXT|safe }}</span>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col" id="correlationDatasetSelection">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col font-weight-bold" id="correlationCovariateSelectionText">
                                                    <span class="align-bottom">{{ config.CORRELATION_SELECT_COVARIATE_TEXT|safe }}</span>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col" id="correlationCovariateSelection">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col" id="correlationDataTable">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col" id="correlationImputation">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col">
                                                    <button id="btnDownloadCorrelationData" type="button" class="btn btn-sm btn-flat btn-primary">
                                                        <i class="fas fa-download"></i> {{ config.CORRELATION_BUTTON_DOWNLOAD_TEXT|safe }}</button>
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col">
                                                    {{ config.CORRELATION_SELECT_ID_TEXT|safe }}
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col" id="correlationDataPlot">
                                                    <div id="plotCorrelation"></div>
                                                </div>
                                            </div>

                                            <div id="divCorrelationCovars">

                                                <div class="row row-spacer"></div>

                                                <div class="row">
                                                    <div class="col font-weight-bold">
                                                        {{ config.CORRELATION_SELECT_SERIES_TEXT|safe }}
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col" id="divFactorSeriesCorrelation">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- end Correlation //-->


                        </div>
                    </div>
                </div>

                <!-- Second column //-->

                <div class="col-md-6 col-lg-7 col-xl-8">

                    <!-- LOD Scan section //-->

                    <!-- only display at first, remove after a succesful selection //-->
                    <div class="row" id="divWelcomeMesage">
                        <div class="col">
                            <div class="jumbotron jumbotron-fluid" style="background: none">
                                <div class="container">
                                    <h1 class="display-3">{{ config.JUMBO_TITLE|safe }}</h1>
                                    <p class="lead">{{ config.JUMBO_TEXT|safe }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col" id="divGenome">
                        </div>
                    </div>

                    <div class="row invisible" id="divItemInfo">
                        <div class="col">
                            <div class="card">
                                <div class="card-header">
                                    <a class="collapsed" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="fa" aria-hidden="true"></i>
                                    <span id="div_current_item_information_header"></span>
                                    </a>
                                </div>
                                <div class="card-body collapse" id="collapseExample">
                                    <div id="div_current_item_information_body"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row invisible" id="divLOD">
                        <div class="col">
                            <div class="card h-100">
                                <div class="card-header" id="lod">
                                    <i class="fas fa-chart-area"></i> {{ config.LOD_CARD_TITLE |safe }}
                                </div>
                                <div class="card-body">

                                    <div class="row">
                                        <div class="col">
                                            <div id="divInteractiveCovariatesLOD"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div id="lodPlotChart"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div id="lodPlotChartCovariateFull"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div id="lodPlotChartCovariateDiff"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- end LOD Scan section //-->

                    <div class="row row-spacer"></div>

                    <div class="row invisible" id="divSecondRow">



                        <!-- Secondary plots //-->

                        <div class="col">
                            <div class="card" id="secondaryPlots">
                                <div class="card-header">
                                    <ul id="secondaryPlotTabs" class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="navPlotEffect" data-toggle="tab" href="#tabPlotEffect"><i class="fa-solid fa-chart-line"></i> {{ config.TAB_EFFECT_PLOT_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="navPlotMediation" data-toggle="tab" href="#tabPlotMediation"><i class="far fa-calendar-alt fa-rotate-180"></i> {{ config.TAB_MEDIATION_PLOT_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="navPlotSNPs" data-toggle="tab" href="#tabPlotSNPs"><i class="fa-solid fa-chart-gantt"></i> {{ config.TAB_SNP_ASSOCIATION_TEXT|safe }}</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="tabPlotEffect">


                                        {% if 'EFFECT_PLOT_OPTIONS' in config %}
                                            {% set EFFECT_PLOT_OPTIONS = config.EFFECT_PLOT_OPTIONS %}
                                        {% else %}
                                            {% set EFFECT_PLOT_OPTIONS = 'NB' %}
                                        {% endif %}


                                        <input type="hidden" id="effect_plot_options" value="{{EFFECT_PLOT_OPTIONS}}"/>

                                        {% if EFFECT_PLOT_OPTIONS == 'NB' %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif EFFECT_PLOT_OPTIONS == 'N' %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" disabled id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif EFFECT_PLOT_OPTIONS == 'B' %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" disabled checked id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}


                                            <div class="row no-gutters">
                                                <div class="col" id="allEffectPlots">
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane" id="tabPlotMediation">
                                            <div class="row">
                                                <div class="col" id="divMediationSelect">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div id="plotMediation"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane" id="tabPlotSNPs">
                                            <div class="row" id="snpWindowMenuShift"></div>
                                            <div class="row" id="snpWindowMenu"></div>
                                            <div class="row">
                                                <div class="col">
                                                    <div id="plotSNPAssociation"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- end Secondary plots //-->

                    </div>
                </div>
                <!-- end Second column //-->

            </div>

        </main>
    </div>

<!-- make some nice circles //-->
<div id="ap" class="invisible">
<svg class="lds-curve-bars" width="200px"  height="200px"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="background: rgba(0, 0, 0, 0) none repeat scroll 0% 0%;"><g transform="translate(50,50)">
</circle><circle cx="0" cy="0" r="18" fill="none" stroke="#1aafd0" stroke-width="1" stroke-dasharray="52 52">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur="1.4s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.2" repeatCount="indefinite"></animateTransform>
</circle><circle cx="0" cy="0" r="22" fill="none" stroke="#6a67ce" stroke-width="1" stroke-dasharray="78 78">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur=".8s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.4" repeatCount="indefinite"></animateTransform>
</circle><circle cx="0" cy="0" r="26" fill="none" stroke="#ffb900" stroke-width="1" stroke-dasharray="104 104">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur="1s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.6" repeatCount="indefinite"></animateTransform>
</circle><circle cx="0" cy="0" r="30" fill="none" stroke="#fc636b" stroke-width="1" stroke-dasharray="130 130">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur="1.2s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.8" repeatCount="indefinite"></animateTransform>
</circle></g></svg>
</div>

<!-- Main Footer -->
<nav class="navbar fixed-bottom navbar-dark bg-dark">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <span class="text-muted">
            <strong>{{ config.CREATED_BY_TEXT|safe }} <a href="{{ config.LAB_URL }}">{{ config.LAB_NAME }}</a>.</strong>
        </span>
      </li>
    </ul>
    <ul class="navbar-nav navbar-expand-sm ml-auto">
        {% if admin %}
        <li class="nav-item pr-5">
            <strong><a class="text-light" href="{{ url_for('admin.index') }}"><i class="fas fa-cogs"></i> Admin</a></strong>
        </li>
        {% endif %}
    <!--
        <li class="nav-item pr-5">
            <strong><a class="text-light" href="{{ url_for('page.dl') }}"><i class="fas fa-file-download"></i> Download Data</a></strong>
        </li>
     //-->
        <li class="nav-item">
            <a class="font-italic text-primary nav-link" id="viewerInfoInformation" data-toggle="modal" data-target="#viewerInfoModal"><i class="fa-solid fa-circle-info"></i> VERSION {{ app_version }}</a>
        </li>
    </ul>
</nav>
<!-- end Main Footer -->


</div>



<!-- START DOWNLOAD DATA MODAL ========================================== //-->
<div class="modal fade modal-fullscreen" id="downloadModal" tabindex="-1" aria-labelledby="downloadLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header rounded-0 bg-dark text-light">
                <h5 class="modal-title" id="downloadLabel">Download Data</h5>
                <a data-dismiss="modal" aria-label="Close"><i class="fa-solid fa-circle-xmark"></i></a>
            </div>

            <div class="modal-body bg-light">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <h2>{{ config.MAIN_TITLE|safe }}</h2>
                            <hr/>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <p class="lead">To download data from {{ config.MAIN_TITLE|safe }}, please click on the filename from the table below.</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div id="envInfoDiv"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--
            <div class="modal-footer">
            </div>
            //-->
        </div>
    </div>
</div>
<!-- END DOWNLOAD DATA MODAL ============================================ //-->

<!-- START VIEWER INFO MODAL ============================================ //-->
<div class="modal fade modal-fullscreen" id="viewerInfoModal" tabindex="-1" aria-labelledby="viewerInfoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header rounded-0 bg-dark text-light">
                <h5 class="modal-title" id="viewerInfoLabel">Viewer Information</h5>
                <a data-dismiss="modal" aria-label="Close"><i class="fa-solid fa-circle-xmark"></i></a>
            </div>

            <div class="modal-body bg-light">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <h2>{{ config.MAIN_TITLE|safe }}</h2>
                            <hr/>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <p class="lead">The QTL Viewer is makes use of a variety of technologies and libraries.</p>
                            QTL Viewer Github Repository: <a target="_new" href="https://github.com/churchill-lab/qtl2web">https://github.com/churchill-lab/qtl2web</a>
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">HTML/Javascript</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "html" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">Python</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "python" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">R</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "R" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">Docker</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "docker" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>


                </div>
            </div>
            <!--
            <div class="modal-footer">
            </div>
            //-->
        </div>
    </div>
</div>
<!-- END VIEWER INFO MODAL ============================================== //-->

</body>
{% endblock %}

{% block javascript %}
    <!-- please wait -->
    <script src="{{ url_for('static', filename='vendor/please-wait-0.0.5/please-wait.js') }}"></script>

    <!-- Loading app //-->
    <script>

    HTMLCanvasElement.prototype.getContext = (function(oldGetContextFn) {
        return function(type, attrs) {
            attrs = attrs || {};
            if (type === 'webgl2') {
                attrs.preserveDrawingBuffer = true;
            }
            return oldGetContextFn.call(this, type, attrs);
        };
    }(HTMLCanvasElement.prototype.getContext));


    function downloadGenomeSpy(parentId, imageName, bgRGB = null){
        let downloadLink = document.createElement('a');
        downloadLink.setAttribute('download', imageName);

        let canvas = document.querySelector(`${parentId} canvas`);

        if (bgRGB != null) {
            var canvasBG = document.createElement('canvas');
            canvasBG.id = 'bgCanvas';
            canvasBG.width = canvas.width;
            canvasBG.height = canvas.height;

            var ctx = canvasBG.getContext('2d');
            ctx.fillStyle = `rgba(${bgRGB}, 1.0)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(canvas, 0, 0);

            canvasBG.toBlob(function(blob) {
                let url = URL.createObjectURL(blob);
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            });
        } else {
            canvas.toBlob(function(blob) {
                let url = URL.createObjectURL(blob);
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            });
        }
    }

    window.loading_screen = window.pleaseWait({
        logo: '',
        backgroundColor: '#000000',
        loadingHtml: '<div id="loader-wrapper"><div id="loader"></div><div class="loader-section section-left"></div><div class="loader-section section-right"></div></div>'
    });
    </script>

    <script src="//cdn.jsdelivr.net/npm/bootstrap-select@1.13.7/dist/js/bootstrap-select.min.js"></script>

    <!-- ENSIMPL API Always use HTTPS -->
    <script src="{{ api_url }}/js/ensimpl.js"></script>


    <!-- Highcharts/Highstock //-->
    {% if debug %}
    <script src="//code.highcharts.com/9.3/highcharts.src.js"></script>
    {% else %}
    <script src="//code.highcharts.com/9.3/highcharts.js"></script>
    {% endif %}
    <script src="//code.highcharts.com/9.3/highcharts-more.js"></script>
    <script src="//code.highcharts.com/9.3/modules/boost.js"></script>
    <script src="//code.highcharts.com/9.3/modules/exporting.js"></script>
    <script src="//code.highcharts.com/9.3/modules/offline-exporting.js"></script>

    <!-- DataTables //-->
    {% if debug %}
    <script src="//cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script src="//cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.js"></script>
    {% else %}
    <script src="//cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="//cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    {% endif %}

    <!-- D3 //-->
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/d3-queue.v3.min.js"></script>
    <script src="//d3js.org/d3-request.v1.min.js"></script>

    <!-- Genome Spy //-->
    <script src="//unpkg.com/@genome-spy/core@0.19.0/dist/index.js"></script>

    <!-- Font Awesome, user: matt.vincent@jax.org //-->
    <script src="//kit.fontawesome.com/56d0cfd040.js" crossorigin="anonymous"></script>

    <!-- Extra //-->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <script src="{{ url_for('static', filename='vendor/dynatables-0.3.1/jquery.dynatable.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/bootstrap-multiselect-0.9.15/dist/js/bootstrap-multiselect.js') }}"></script>
    

    <!-- Need to load global data object first -->
    <script src="{{ url_for('static', filename='js/global.js') }}"></script>

    <script> 
        const debugMode = {{ debug|tojson }};
        const apiURL = '{{ api_url }}';
        const chromosomeBaseURL = `{{ url_for('api.api_get', url='', _external=False) }}${apiURL}/api/chromosomes`;
        const lodPeaksBaseURL = '{{ url_for('api.api_get', url=config.API_R_BASE + '/lodpeaks', _external=False) }}';
        const envInfoURL = '{{ url_for('api.api_get', url=config.API_R_BASE + '/envinfo', _external=False) }}';
        const dataSetsURL = '{{ url_for('api.api_get', url=config.API_R_BASE + '/datasets', _external=False) }}';
        const submitURL = '{{ url_for('api.api_submit', _external=False) }}';
        const statusBaseURL = '{{ url_for('api.api_status', group_id='', _external=False) }}';
        const pageErrorURL = '{{ url_for('page.error') }}';
        const cancelBaseURL = '{{ url_for('api.api_cancel', group_id='', _external=False) }}';
        const rBaseURL = '{{ config.API_R_BASE }}';
        const downloadURL = '{{ url_for('page.dl') }}';


        const global = new Global();
        global.CHROMOSOMES = {{ config.CHROMOSOMES|safe }};
        const requestedDataSetID = '{{ datasetid }}';


        const plotEffectStrains = {{ config.PLOT_EFFECT_STRAINS | tojson | safe }};
        {% if config.PLOT_EFFECT_COVARIATES is defined %}
        const plotLODLines = {{ config.PLOT_LOD_LINES | tojson | safe }};
        {% else %}
        const plotLODLines = null;
        {% endif %}
        // Fixes issue where R num cores is not defined
        {% if config.API_R_NUM_CORES is defined %}
        const rNumCores = {{ config.API_R_NUM_CORES }};
        {% else %}
        const rNumCores = null;
        {% endif %}
        const navDataset = `{{ config.NAV_DATASET|safe }}`;
        const mainTitle = `{{ config.MAIN_TITLE|safe }}`;
        
    </script>  

    <script src="{{ url_for('static', filename='js/utilities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/high_chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.extensions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/download.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tasks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/manage_tabs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataset.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/correlation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/profile_plot.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/effect.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/mediation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/info.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/snp_association.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/lod_peaks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/search.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/covariate.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/lod.js') }}"></script>    



    <script>

        
    function buildEnvInfo(envInfo) {
        let htmlBody = '<table id="envInfoTable" class="table table-striped table-bordered table-sm table-sm-text">';
        htmlBody += '<thead><th>Filename</th><th>Size</th><th>Elements</th></thead>';
        $.each(envInfo, function(idx, value) {
            logDebug('value=', value);
            let fileSize = niceBytes(value.fileSize);
            htmlBody += `
                <tr>
                    <td data-order="${value.fileName}">
                        <a href="#" fileName="${value.fileName}">${value.fileName}</a>
                    </td>
                    <td>
                        ${fileSize}
                    </td>
                    <td>
            `;

            if(typeof value.elements === 'string') {
                htmlBody += value.elements;
            } else {
                htmlBody += value.elements.join('<br>');
            }

            htmlBody += '</td></tr>';
        });

        htmlBody += '</table>';
        $('#envInfoDiv').html(htmlBody);

        $('#envInfoTable').DataTable({
            "info":   false,
            "filter": false,
            "paging": false
        });

        $('#envInfoTable a').click(function(evt) {
            evt.preventDefault();
            let that = $(this);
            let f = that.attr('fileName');
            window.location = `${downloadURL}?fileName=${f}`;
            return false;
        });
    }

    QTL = function() {
        function init() {

            d3.queue()
                .defer(downloadEnvInfo)
                .defer(downloadDataSets)
                .await(function(error, envInfo, data) {
                    logDebug('envInfo=', envInfo);
                    logDebug('dataSetsData=', data);

                    if (error) {
                        logError(error);
                        if (!debugMode) { // redirect to error page if not in debug mode
                            window.location = pageErrorURL;
                        }
                        return;
                    }

                    if ((data.result === undefined) || (data.result.datasets.length === 0)) {
                        logError('data=', data);
                        if (!debugMode) { // redirect to error page if not in debug mode
                            window.location = pageErrorURL;
                        }
                        return;
                    }

                    global.resetDatasets();

                    buildEnvInfo(envInfo.result);

                    // Possible keys for the Ensembl release version.
                    const possibleKeys = ['ensembl.version', 'ensembl_version', 'ensembl.release', 'ensembl_release'];

                    // Find the first existing key and retrieve its value directly.
                    const keyFound = possibleKeys.find(key => key in data.result);
                    const ensembl_release = keyFound ? data.result[keyFound] : null;

                    // to display dropdown menu by alphabetical name
                    let datasets_dropdown = {};

                    $.each(data.result.datasets, function(dsi, ds) {
                        ds.gene_ids = {};
                        ds.protein_ids = {};
                        ds.phos_ids = {};
                        ds.phenotypes = {};

                        if ('ensembl_version' in ds) {
                            ds.ensembl_release  = ds['ensembl_version'];
                        } else if ('ensembl_release' in ds) {
                            ds.ensembl_release  = ds['ensembl_release'];
                        } else {
                            ds.ensembl_release = ensembl_release;
                        }

                        // TODO: Fix hardcoding
                        ds.ensembl_species = 'Mm';

                        // change the case so we don't have to throughout
                        ds.datatype = ds.datatype.toLowerCase();
                        logDebug('ds.datatype=', ds.datatype);

                        if (ds.datatype === 'mrna') {
                            // convert array to object (hash)
                            // ds.gene_ids = dictionary with just a 1
                            $.each(ds.annotations, function(index, element) {
                                ds.gene_ids[element['gene_id']] = 1;
                            });
                        } else if (ds.datatype === 'protein') {
                            // ds.gene_ids = dictionary with id and array of protein_ids
                            // ds.protein_ids = dictionary with id mapped to gene id
                            $.each(ds.annotations, function(index, element) {
                                if (!(element['gene_id'] in ds.gene_ids)) {
                                    ds.gene_ids[element['gene_id']] = {
                                        'id': element['gene_id'],
                                        'protein_ids':[]
                                    };
                                }
                                ds.protein_ids[element['protein_id']] = element['gene_id'];
                                ds.gene_ids[element['gene_id']].protein_ids.push(element['protein_id']);
                            });
                        } else if (ds.datatype === 'phos') {
                            // ds.gene_ids = dictionary with id and array of protein ids
                            // ds.protein_ids = dictionary with id and array of phos_ids and gene id
                            // ds.phos_ids = dictionary with id and gene_id and protein_id
                            $.each(ds.annotations, function(index, element) {
                                if (!(element['gene_id'] in ds.gene_ids)) {
                                    ds.gene_ids[element['gene_id']] = {
                                        'id': element['gene_id'],
                                        'protein_ids':[]
                                    };
                                }

                                if (!(element['protein_id'] in ds.protein_ids)) {
                                    ds.protein_ids[element['protein_id']] = {
                                        'id': element['protein_id'],
                                        'gene_id': element['gene_id'],
                                        'phos_ids':[]
                                    };

                                    ds.gene_ids[element['gene_id']].protein_ids.push(element['protein_id']);
                                }

                                ds.phos_ids[element['phos_id']] = {
                                    'gene_id': element['gene_id'],
                                    'protein_id': element['protein_id']
                                }

                                ds.protein_ids[element['protein_id']].phos_ids.push(element['phos_id']);

                            });
                        } else if ((ds.datatype === 'pheno') || (ds.datatype === 'phenotype')) {
                            ds.datatype = 'pheno';
                            logDebug(ds.id);
                            logDebug(ds.annotations);


                            $.each(ds.annotations, function(index, element) {
                                ds.phenotypes[element['data_name']] = element;
                            });
                        } else {
                            // TODO: handle error
                            logError('ERROR in dataset data:', ds);
                        }

                        // don't need the extra annotations laying around
                        delete ds.annotations;

                        datasets_dropdown[ds['display_name']] = ds.id;

                        global.addDataset(ds); 
                    });

                    datasets_dropdown = sortObj(datasets_dropdown);

                    

                    if (global.datasetExists(requestedDataSetID)) {
                        global.setDatasetID(requestedDataSetID);
                    } else {
                        global.setDatasetID(datasets_dropdown[Object.keys(datasets_dropdown)[0]]);
                    }

                    // the above if is working, but we need to think through all of
                    // the other ramifications of setting this dataset

                    configureCovarInfo(true);

                    logDebug('data.result.datasets.length=',data.result.datasets.length);

                    if (data.result.datasets.length === 1) {
                        // just show a menu item
                        let html = `<ul class="navbar-nav navbar-dark mr-auto">
                                        <li class="nav-item active" style="color:white">
                                            ${global.currentDataset['display_name']}
                                        </li>
                                        <li class="nav-item">
                                            <a class="font-italic text-primary nav-link" id="downloadInformation" data-toggle="modal" data-target="#downloadModal"><i class="fa-solid fa-download"></i> Download Data</a>
                                        </li>
                                    </ul>`;

                        $('#dataSetSelectMenu').append(html);
                        $('#correlationDatasetSelection').html(`${global.currentDataset['display_name']}`);
                        $('#correlationDatasetSelection').append(`<input type="hidden" id="correlationDatasetSelect" value="${global.currentDataset.id}"/>`);

                    } else if (data.result.datasets.length > 1) {
                        // show multiple menu items
                        let html = `<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerQTL" aria-controls="navbarTogglerQTL" aria-expanded="false" aria-label="Toggle navigation">
                                        <span class="navbar-toggler-icon"></span>
                                    </button>
                                    <div class="collapse navbar-dark navbar-collapse" id="navbarTogglerQTL">
                                        <span class="navbar-text text-white pr-2">
                                            ${navDataset} <i class="fas fa-long-arrow-alt-right"></i>
                                        </span>
                                        <form class="form-inline">
                                            <select data-style="btn-sm btn-light" class="selectpicker" id="datasetSelect">
                                            </select>
                                        </form>
                                        <ul class="navbar-nav mr-auto">
                                            <li class="nav-item">
                                                <a class="font-italic text-primary nav-link" id="downloadInformation" data-toggle="modal" data-target="#downloadModal"><i class="fa-solid fa-download"></i> Download Data</a>
                                            </li>
                                        </ul>
                                     </div>
                                    `;

                        $('#dataSetSelectMenu').append(html);

                        // display datasets by sorted name
                        for (let d in datasets_dropdown) {
                            let _id = datasets_dropdown[d];
                            if (global.datasetID === _id) {
                                $('#datasetSelect').append(`<option value="${_id}" selected>${d}</option>`);
                            } else {
                                $('#datasetSelect').append(`<option value="${_id}">${d}</option>`);
                            }
                        }

                        $('#datasetSelect').selectpicker();

                        $('#datasetSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                            let selected = $(this).find(':selected').val();
                            switchDataSet(selected);
                        });

                        // show multiple menu items
                        let htmlNew = `<select id="correlationDatasetSelect" data-width="100%" data-style="btn-secondary btn-sm" class="selectpicker">`;

                        for (let d in datasets_dropdown) {
                            let _id = datasets_dropdown[d];
                            if (global.datasetID === _id) {
                                htmlNew += `<option value="${_id}" selected>${d}</option>`;
                            } else {
                                htmlNew += `<option value="${_id}">${d}</option>`;
                            }
                        }
                        htmlNew += '</select>';

                        $('#correlationDatasetSelection').html(htmlNew);

                        $('#correlationDatasetSelect').selectpicker();

                        $('#correlationDatasetSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                            let selected = $(this).find(':selected').val();
                            let interactiveCovariate = $('#interactiveCovarCorrelation').find(':selected').val();
                            switchCorrelationDataSet(selected, interactiveCovariate);
                        });
                    }

                    global.ENSIMPL = new ensimpl({
                        greedy: true,
                        search_limit: 100,
                        search_release: global.currentDataset.ensembl_release,
                        search_species: global.currentDataset.ensembl_species,
                    });

                    d3.queue()
                        .defer(downloadChromosomes, global.currentDataset.ensembl_release, global.currentDataset.ensembl_species, global.currentDataset.id)
                        .defer(downloadLODPeaks, global.datasetID)
                        .await(function(errorPeaks, chromosomes, lodPeaks) {
                            global.currentDataset.chromosomes = {
                                'idx': [],
                                'chr': {},
                                'contigs':[]
                            };


                            global.currentDataset.ensembl = {
                                'species': chromosomes.meta.species,
                                'assembly': chromosomes.meta.assembly,
                                'assembly_patch': chromosomes.meta.assembly_patch,
                                'release': chromosomes.meta.release,
                                'url': chromosomes.meta.url
                            };

                            
                            let start = 1;
                            let end = 0;

                            $.each(chromosomes.chromosomes, function(index, element) {
                                if (global.CHROMOSOMES.indexOf(element.chromosome) !== -1) {
                                    let chrom = element;

                                    start = end + 1;
                                    end += chrom.length;

                                    chrom.start = start;
                                    chrom.end = end;
                                    chrom.mid = chrom.start + Math.ceil((chrom.end - chrom.start) / 2);

                                    global.currentDataset.chromosomes.idx.push(chrom);
                                    global.currentDataset.chromosomes.chr[element.chromosome] = chrom;
                                    global.currentDataset.chromosomes.contigs.push({
                                        "name": chrom.chromosome,
                                        "size": chrom.length,
                                    });
                                }
                            });

                            global.currentDataset.chromosomes.totalLength = end;
                            global.currentDataset.lodpeaks = lodPeaks.result;

                            setDataSet(global.datasetID, true);

                            logDebug('Hiding loading screen');
                            window.loading_screen.finish();
                        });

                    // download all the other load peaks from all the datasets except the current one
                    // we do this in the background to gain some performance
                    let q = d3.queue();
                    logDebug('Downloading the peaks and chromosomes...');

                    $.each(global.DATASETS, function(key, value) {
                        if (key !== global.datasetID) {
                            q.defer(downloadLODPeaks, key);
                            q.defer(downloadChromosomes, global.getDataset(key).ensembl_release, global.getDataset(key).ensembl_species, key);
                        }
                    });

                    q.awaitAll(function(errorAll, results) {
                        // TODO: handle error
                        $.each(results, function(key, value) {
                            if ('chromosomes' in value) {
                                let _id = value['_description'].split(' ')[1];
                                global.getDataset(_id).chromosomes = {
                                    'idx': [],
                                    'chr': {},
                                    'contigs': []
                                };

                                global.getDataset(_id).ensembl = {
                                    'species': value.meta.species,
                                    'assembly': value.meta.assembly,
                                    'assembly_patch': value.meta.assembly_patch,
                                    'release': value.meta.release,
                                    'url': value.meta.url
                                };

                                let start = 1;
                                let end = 0;

                                $.each(value.chromosomes, function(index, element) {
                                    if (global.CHROMOSOMES.indexOf(element.chromosome) !== -1) {
                                        let chrom = element;

                                        start = end + 1;
                                        end += chrom.length;

                                        chrom.start = start;
                                        chrom.end = end;
                                        chrom.mid = chrom.start + Math.ceil((chrom.end - chrom.start) / 2);

                                        global.getDataset(_id).chromosomes.idx.push(chrom);
                                        global.getDataset(_id).chromosomes.chr[element.chromosome] = chrom;
                                        global.getDataset(_id).chromosomes.contigs.push({
                                            "name": chrom.chromosome,
                                            "size": chrom.length,
                                        });
                                    }
                                });

                                global.getDataset(_id).chromosomes.totalLength = end;
                                logDebug('global.getDataset(_id).chromosomes=', global.getDataset(_id).chromosomes);

                            } else {
                                global.getDataset(value.parameters.dataset).lodpeaks = value.result;
                            }
                        });
                    });
                });
            }

        return {
            init: init
        }
    }();

    $().ready(function () {
        QTL.init();

        // handle search
        $('#searchTerm').keypress(function(evt) {
            let code = evt.which ? evt.which : evt.keyCode;
            if (code === 13) {
                $(this).blur();
                $('#btnGo').focus().click();
            }
        });

        $('#btnGo').button().on('click', function(evt) {
            evt.preventDefault();
            let term = $('#searchTerm');
            findGene(term.val().trim().toUpperCase());
            return false;
        });

        // set some global options for Highcharts
        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: $('body').css('font-family')
                },
            },

            credits: {
                enabled: false
            },

            exporting: {
                buttons: {
                    contextButton: {
                        menuItems: [
                            'downloadPNG'
                        ]
                    }
                },
            },
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
           $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
        });

    });
    </script>

{% endblock %}

