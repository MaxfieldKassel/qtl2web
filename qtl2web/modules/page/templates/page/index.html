{% extends 'layouts/base.html' %}
{% block title %}{{ config.MAIN_TITLE|safe }}{% endblock %}
{% block meta_description %}{% endblock %}
{% block head %}
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css"/>

    <link rel="stylesheet"
          href="//cdn.jsdelivr.net/npm/bootstrap-select@1.13.7/dist/css/bootstrap-select.min.css"/>

    <link rel="stylesheet"
          href="//cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>

    <link rel="stylesheet"
          href="//cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css"/>

    <link rel="stylesheet"
          href="//unpkg.com/@genome-spy/core@0.19.0/dist/style.css"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/please-wait-0.0.5/please-wait.css') }}"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/dynatables-0.3.1/jquery.dynatable.css')}}"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/bootstrap-multiselect-0.9.15/dist/css/bootstrap-multiselect.css') }}"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='styles/main.css') }}"/>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D1707LSMF4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D1707LSMF4');
    </script>

    <style>
    <!--
        body {
            /*font-family: 'Roboto', sans-serif !important;*/
            /*font-family: IBM Plex Sans, sans-serif !important;*/
            font-family: system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
        }

        .genome-spy .tooltip {
            opacity: 100;
        }

        .snpMenuIcon a:hover {
            background: #3374C2;
        }

.modal.modal-fullscreen .modal-dialog {
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
  max-width: none;
}

.modal.modal-fullscreen .modal-content {
  height: auto;
  height: 100vh;
  border-radius: 0;
  border: none;
}

.modal.modal-fullscreen .modal-body {
  overflow-y: auto;
}

    //-->
    </style>
{% endblock %}
{% block body %}
<body>
<div class="inner">

    <nav id="dataSetSelectMenu" class="navbar navbar-expand-sm bg-dark navbar-dark fixed-top">
        <a class="navbar-brand" href="#">{{ config.NAV_TITLE|safe }}</a>
        <!-- will be filled in programatically //-->

    </nav>

    <div class="container-fluid">

        <main class="col-12" role="main">
            <div class="row">

                <div class="col-md-6 col-lg-5 col-xl-4">

                    <div class="row">
                        <div class="col">

                            <!-- Gene/Protein/Pheno selection //-->
                            <div class="card h-100">
                                <div class="card-header">
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a id="navPheno"
                                               class="nav-link"
                                               data-toggle="tab"
                                               href="#tabSearchPheno"><i class="fab fa-searchengin"></i> {{ config.TAB_SEARCH_PHENOTYPE_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a id="navGene"
                                               class="nav-link"
                                               data-toggle="tab"
                                               href="#tabSearchGene"><i class="fas fa-search"></i> {{ config.TAB_SEARCH_MRNA_PROTEIN_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a id="navLodPeaks"
                                               class="nav-link"
                                               data-toggle="tab"
                                               href="#tabLodPeaks"><i class="fas fa-th"></i> {{ config.TAB_LOD_PEAKS_TEXT|safe }}</a>
                                        </li>
                                    </ul>
                                </div>

                                <div class="card-body">
                                    <div class="tab-content">
                                        <div class="tab-pane h-100" role="tabpanel" id="tabSearchPheno">

                                            <div class="row">
                                                <div class="col" id="searchPheno">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col" id="searchPhenoCategoryText">
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col" id="searchPhenoCategory">
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div class="py-0" id="searchPhenoResultsInfo">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col results-wrapper">
                                                    <div id="searchPhenoResultsDiv"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane h-100" role="tabpanel" id="tabSearchGene">
                                            <div class="row">
                                                <div class="col">
                                                    <div class="input-group">
                                                        <input type="text" id="searchTerm" name="searchTerm" class="form-control" placeholder="{{ config.SEARCH_BOX_TEXT|safe }}">
                                                        <span class="input-group-append">
                                                            <button id="btnGo" class="btn btn-primary"><i class="fas fa-search"></i></button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div class="py-2" id="searchResultsTableInfo"></div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div id="searchResultsDiv"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane h-100" role="tabpanel" id="tabLodPeaks">

                                            <div class="row">
                                                <div class="col">
                                                    <div id="divInteractiveCovariatesPeaks"></div>
                                                </div>
                                            </div>
                                            <div class="row" id="divLODPeaksMenu"></div>
                                            <div class="row">
                                                <div class="col">
                                                    <div id="divLODPeaks"></div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- end Gene/Protein/Pheno selection //-->

                        </div>
                    </div>

                    <div class="row row-spacer"></div>

                    <div class="row invisible" id="divProfileCorrelation">
                        <div class="col">

                            <div class="card h-100">
                                <div class="card-header" id="profilePlot">
                                    <ul id="infoTabs" class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="navProfile" data-toggle="tab" href="#tabProfile"><i class="fas fa-calculator"></i> {{ config.TAB_PROFILE_PLOT_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="navCorrelation" data-toggle="tab" href="#tabCorrelation"><i class="fa-brands fa-uncharted"></i> {{ config.TAB_CORRELATION_TEXT|safe }}</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">

                                    <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="tabProfile">

                                            <div class="row" id="divProfilePlotOptions">

                                            </div>

                                            <div class="row" id="fact-svg-panel">
                                                <div class="col">
                                                    <div id="profilePlotChart"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane" id="tabCorrelation">
                                            <div class="row">
                                                <div class="col font-weight-bold">
                                                    <span class="align-bottom">{{ config.CORRELATION_SELECT_DATASET_TEXT|safe }}</span>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col" id="correlationDatasetSelection">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col font-weight-bold" id="correlationCovariateSelectionText">
                                                    <span class="align-bottom">{{ config.CORRELATION_SELECT_COVARIATE_TEXT|safe }}</span>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col" id="correlationCovariateSelection">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col" id="correlationDataTable">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col" id="correlationImputation">
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col">
                                                    <button id="btnDownloadCorrelationData" type="button" class="btn btn-sm btn-flat btn-primary">
                                                        <i class="fas fa-download"></i> {{ config.CORRELATION_BUTTON_DOWNLOAD_TEXT|safe }}</button>
                                                </div>
                                            </div>

                                            <div class="row row-spacer"></div>

                                            <div class="row">
                                                <div class="col">
                                                    {{ config.CORRELATION_SELECT_ID_TEXT|safe }}
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col" id="correlationDataPlot">
                                                    <div id="plotCorrelation"></div>
                                                </div>
                                            </div>

                                            <div id="divCorrelationCovars">

                                                <div class="row row-spacer"></div>

                                                <div class="row">
                                                    <div class="col font-weight-bold">
                                                        {{ config.CORRELATION_SELECT_SERIES_TEXT|safe }}
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col" id="divFactorSeriesCorrelation">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- end Correlation //-->


                        </div>
                    </div>
                </div>

                <!-- Second column //-->

                <div class="col-md-6 col-lg-7 col-xl-8">

                    <!-- LOD Scan section //-->

                    <!-- only display at first, remove after a succesful selection //-->
                    <div class="row" id="divWelcomeMesage">
                        <div class="col">
                            <div class="jumbotron jumbotron-fluid" style="background: none">
                                <div class="container">
                                    <h1 class="display-3">{{ config.JUMBO_TITLE|safe }}</h1>
                                    <p class="lead">{{ config.JUMBO_TEXT|safe }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col" id="divGenome">
                        </div>
                    </div>

                    <div class="row invisible" id="divItemInfo">
                        <div class="col">
                            <div class="card">
                                <div class="card-header">
                                    <a class="collapsed" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="fa" aria-hidden="true"></i>
                                    <span id="div_current_item_information_header"></span>
                                    </a>
                                </div>
                                <div class="card-body collapse" id="collapseExample">
                                    <div id="div_current_item_information_body"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row invisible" id="divLOD">
                        <div class="col">
                            <div class="card h-100">
                                <div class="card-header" id="lod">
                                    <i class="fas fa-chart-area"></i> {{ config.LOD_CARD_TITLE |safe }}
                                </div>
                                <div class="card-body">

                                    <div class="row">
                                        <div class="col">
                                            <div id="divInteractiveCovariatesLOD"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div id="lodPlotChart"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div id="lodPlotChartCovariateFull"></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div id="lodPlotChartCovariateDiff"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- end LOD Scan section //-->

                    <div class="row row-spacer"></div>

                    <div class="row invisible" id="divSecondRow">



                        <!-- Secondary plots //-->

                        <div class="col">
                            <div class="card" id="secondaryPlots">
                                <div class="card-header">
                                    <ul id="secondaryPlotTabs" class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="navPlotEffect" data-toggle="tab" href="#tabPlotEffect"><i class="fa-solid fa-chart-line"></i> {{ config.TAB_EFFECT_PLOT_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="navPlotMediation" data-toggle="tab" href="#tabPlotMediation"><i class="far fa-calendar-alt fa-rotate-180"></i> {{ config.TAB_MEDIATION_PLOT_TEXT|safe }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="navPlotSNPs" data-toggle="tab" href="#tabPlotSNPs"><i class="fa-solid fa-chart-gantt"></i> {{ config.TAB_SNP_ASSOCIATION_TEXT|safe }}</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="tabPlotEffect">


                                        {% if 'EFFECT_PLOT_OPTIONS' in config %}
                                            {% set EFFECT_PLOT_OPTIONS = config.EFFECT_PLOT_OPTIONS %}
                                        {% else %}
                                            {% set EFFECT_PLOT_OPTIONS = 'NB' %}
                                        {% endif %}


                                        <input type="hidden" id="effect_plot_options" value="{{EFFECT_PLOT_OPTIONS}}"/>

                                        {% if EFFECT_PLOT_OPTIONS == 'NB' %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif EFFECT_PLOT_OPTIONS == 'N' %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" disabled id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif EFFECT_PLOT_OPTIONS == 'B' %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" disabled checked id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="row">
                                                <div class="col">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" id="performBLUP">
                                                        <label class="custom-control-label" for="performBLUP">{{ config.SWITCH_BLUP_TEXT|safe }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}


                                            <div class="row no-gutters">
                                                <div class="col" id="allEffectPlots">
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane" id="tabPlotMediation">
                                            <div class="row">
                                                <div class="col" id="divMediationSelect">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div id="plotMediation"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div role="tabpanel" class="tab-pane" id="tabPlotSNPs">
                                            <div class="row" id="snpWindowMenuShift"></div>
                                            <div class="row" id="snpWindowMenu"></div>
                                            <div class="row">
                                                <div class="col">
                                                    <div id="plotSNPAssociation"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- end Secondary plots //-->

                    </div>
                </div>
                <!-- end Second column //-->

            </div>

        </main>
    </div>

<!-- make some nice circles //-->
<div id="ap" class="invisible">
<svg class="lds-curve-bars" width="200px"  height="200px"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="background: rgba(0, 0, 0, 0) none repeat scroll 0% 0%;"><g transform="translate(50,50)">
</circle><circle cx="0" cy="0" r="18" fill="none" stroke="#1aafd0" stroke-width="1" stroke-dasharray="52 52">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur="1.4s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.2" repeatCount="indefinite"></animateTransform>
</circle><circle cx="0" cy="0" r="22" fill="none" stroke="#6a67ce" stroke-width="1" stroke-dasharray="78 78">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur=".8s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.4" repeatCount="indefinite"></animateTransform>
</circle><circle cx="0" cy="0" r="26" fill="none" stroke="#ffb900" stroke-width="1" stroke-dasharray="104 104">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur="1s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.6" repeatCount="indefinite"></animateTransform>
</circle><circle cx="0" cy="0" r="30" fill="none" stroke="#fc636b" stroke-width="1" stroke-dasharray="130 130">
<animateTransform attributeName="transform" type="rotate" values="0 0 0;360 0 0" times="0;1" dur="1.2s" calcMode="spline" keySplines="0.2 0 0.8 1" begin="-0.8" repeatCount="indefinite"></animateTransform>
</circle></g></svg>
</div>

<!-- Main Footer -->
<nav class="navbar fixed-bottom navbar-dark bg-dark">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <span class="text-muted">
            <strong>{{ config.CREATED_BY_TEXT|safe }} <a href="{{ config.LAB_URL }}">{{ config.LAB_NAME }}</a>.</strong>
        </span>
      </li>
    </ul>
    <ul class="navbar-nav navbar-expand-sm ml-auto">
        {% if admin %}
        <li class="nav-item pr-5">
            <strong><a class="text-light" href="{{ url_for('admin.index') }}"><i class="fas fa-cogs"></i> Admin</a></strong>
        </li>
        {% endif %}
    <!--
        <li class="nav-item pr-5">
            <strong><a class="text-light" href="{{ url_for('page.dl') }}"><i class="fas fa-file-download"></i> Download Data</a></strong>
        </li>
     //-->
        <li class="nav-item">
            <a class="font-italic text-primary nav-link" id="viewerInfoInformation" data-toggle="modal" data-target="#viewerInfoModal"><i class="fa-solid fa-circle-info"></i> VERSION {{ app_version }}</a>
        </li>
    </ul>
</nav>
<!-- end Main Footer -->


</div>



<!-- START DOWNLOAD DATA MODAL ========================================== //-->
<div class="modal fade modal-fullscreen" id="downloadModal" tabindex="-1" aria-labelledby="downloadLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header rounded-0 bg-dark text-light">
                <h5 class="modal-title" id="downloadLabel">Download Data</h5>
                <a data-dismiss="modal" aria-label="Close"><i class="fa-solid fa-circle-xmark"></i></a>
            </div>

            <div class="modal-body bg-light">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <h2>{{ config.MAIN_TITLE|safe }}</h2>
                            <hr/>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <p class="lead">To download data from {{ config.MAIN_TITLE|safe }}, please click on the filename from the table below.</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div id="envInfoDiv"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--
            <div class="modal-footer">
            </div>
            //-->
        </div>
    </div>
</div>
<!-- END DOWNLOAD DATA MODAL ============================================ //-->

<!-- START VIEWER INFO MODAL ============================================ //-->
<div class="modal fade modal-fullscreen" id="viewerInfoModal" tabindex="-1" aria-labelledby="viewerInfoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header rounded-0 bg-dark text-light">
                <h5 class="modal-title" id="viewerInfoLabel">Viewer Information</h5>
                <a data-dismiss="modal" aria-label="Close"><i class="fa-solid fa-circle-xmark"></i></a>
            </div>

            <div class="modal-body bg-light">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <h2>{{ config.MAIN_TITLE|safe }}</h2>
                            <hr/>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <p class="lead">The QTL Viewer is makes use of a variety of technologies and libraries.</p>
                            QTL Viewer Github Repository: <a target="_new" href="https://github.com/churchill-lab/qtl2web">https://github.com/churchill-lab/qtl2web</a>
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">HTML/Javascript</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "html" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">Python</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "python" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">R</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "R" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <br/><br/>

                    <div class="row">
                        <div class="col">
                            <h5 class="modal-title" id="viewerInfoLabel">Docker</h5>
                            <hr/>
                            {% for tech in TECHNOLOGIES %}
                                {% if "docker" in tech.category %}
                                <a target="_new" href="{{ tech.url }}">{{ tech.name }}</a> {{ tech.version }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>


                </div>
            </div>
            <!--
            <div class="modal-footer">
            </div>
            //-->
        </div>
    </div>
</div>
<!-- END VIEWER INFO MODAL ============================================== //-->

</body>
{% endblock %}

{% block javascript %}
    <!-- please wait -->
    <script src="{{ url_for('static', filename='vendor/please-wait-0.0.5/please-wait.js') }}"></script>

    <!-- Loading app //-->
    <script>

    HTMLCanvasElement.prototype.getContext = (function(oldGetContextFn) {
        return function(type, attrs) {
            attrs = attrs || {};
            if (type === 'webgl2') {
                attrs.preserveDrawingBuffer = true;
            }
            return oldGetContextFn.call(this, type, attrs);
        };
    }(HTMLCanvasElement.prototype.getContext));


    function downloadGenomeSpy(parentId, imageName, bgRGB = null){
        let downloadLink = document.createElement('a');
        downloadLink.setAttribute('download', imageName);

        let canvas = document.querySelector(`${parentId} canvas`);

        if (bgRGB != null) {
            var canvasBG = document.createElement('canvas');
            canvasBG.id = 'bgCanvas';
            canvasBG.width = canvas.width;
            canvasBG.height = canvas.height;

            var ctx = canvasBG.getContext('2d');
            ctx.fillStyle = `rgba(${bgRGB}, 1.0)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(canvas, 0, 0);

            canvasBG.toBlob(function(blob) {
                let url = URL.createObjectURL(blob);
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            });
        } else {
            canvas.toBlob(function(blob) {
                let url = URL.createObjectURL(blob);
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            });
        }
    }

    window.loading_screen = window.pleaseWait({
        logo: '',
        backgroundColor: '#000000',
        loadingHtml: '<div id="loader-wrapper"><div id="loader"></div><div class="loader-section section-left"></div><div class="loader-section section-right"></div></div>'
    });
    </script>

    <script src="//cdn.jsdelivr.net/npm/bootstrap-select@1.13.7/dist/js/bootstrap-select.min.js"></script>

    <!-- ENSIMPL API -->
    <script src="//{{ api_url }}/js/ensimpl.js"></script>

    <!-- Highcharts/Highstock //-->
    {% if debug %}
    <script src="//code.highcharts.com/9.3/highcharts.src.js"></script>
    {% else %}
    <script src="//code.highcharts.com/9.3/highcharts.js"></script>
    {% endif %}
    <script src="//code.highcharts.com/9.3/highcharts-more.js"></script>
    <script src="//code.highcharts.com/9.3/modules/boost.js"></script>
    <script src="//code.highcharts.com/9.3/modules/exporting.js"></script>
    <script src="//code.highcharts.com/9.3/modules/offline-exporting.js"></script>

    <!-- DataTables //-->
    {% if debug %}
    <script src="//cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script src="//cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.js"></script>
    {% else %}
    <script src="//cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="//cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    {% endif %}

    <!-- D3 //-->
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/d3-queue.v3.min.js"></script>
    <script src="//d3js.org/d3-request.v1.min.js"></script>

    <!-- Genome Spy //-->
    <script src="//unpkg.com/@genome-spy/core@0.19.0/dist/index.js"></script>

    <!-- Font Awesome, user: matt.vincent@jax.org //-->
    <script src="//kit.fontawesome.com/56d0cfd040.js" crossorigin="anonymous"></script>

    <!-- Extra //-->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <script src="{{ url_for('static', filename='vendor/dynatables-0.3.1/jquery.dynatable.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/bootstrap-multiselect-0.9.15/dist/js/bootstrap-multiselect.js') }}"></script>
    

    <!-- Need to load global data object first -->
    <script src="{{ url_for('static', filename='js/global.js') }}"></script>

    <script> 
        const debugMode = {{ debug|tojson }};
        const apiURL = '{{ api_url }}';
        const chromosomeBaseURL = `{{ url_for('api.api_get', url='', _external=False) }}${window.location.protocol}//${apiURL}/api/chromosomes`;
        const lodPeaksBaseURL = '{{ url_for('api.api_get', url=config.API_R_BASE + '/lodpeaks', _external=False) }}';
        const envInfoURL = '{{ url_for('api.api_get', url=config.API_R_BASE + '/envinfo', _external=False) }}';
        const dataSetsURL = '{{ url_for('api.api_get', url=config.API_R_BASE + '/datasets', _external=False) }}';
        const submitURL = '{{ url_for('api.api_submit', _external=False) }}';
        const statusBaseURL = '{{ url_for('api.api_status', group_id='', _external=False) }}';
        const pageErrorURL = '{{ url_for('page.error') }}';
        const cancelBaseURL = '{{ url_for('api.api_cancel', group_id='', _external=False) }}';
        const rBaseURL = '{{ config.API_R_BASE }}';
        const downloadURL = '{{ url_for('page.dl') }}';


        const global = new Global();
        global.CHROMOSOMES = {{ config.CHROMOSOMES|safe }};
        const requestedDataSetID = '{{ datasetid }}';


        const plotEffectStrains = {{ config.PLOT_EFFECT_STRAINS | tojson | safe }};
        {% if config.PLOT_EFFECT_COVARIATES is defined %}
        const plotLODLines = {{ config.PLOT_LOD_LINES | tojson | safe }};
        {% else %}
        const plotLODLines = null;
        {% endif %}
        // Fixes issue where R num cores is not defined
        {% if config.API_R_NUM_CORES is defined %}
        const rNumCores = {{ config.API_R_NUM_CORES }};
        {% else %}
        const rNumCores = null;
        {% endif %}
        const navDataset = `{{ config.NAV_DATASET|safe }}`;
        const mainTitle = `{{ config.MAIN_TITLE|safe }}`;
        
    </script>  

    <script src="{{ url_for('static', filename='js/utilities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/high_chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.extensions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/download.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tasks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/correlation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/profile_plot.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/effect.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/mediation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/info.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/snp_association.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs/lod_peaks.js') }}"></script>



    <script>

        
    function buildEnvInfo(envInfo) {
        let htmlBody = '<table id="envInfoTable" class="table table-striped table-bordered table-sm table-sm-text">';
        htmlBody += '<thead><th>Filename</th><th>Size</th><th>Elements</th></thead>';
        $.each(envInfo, function(idx, value) {
            logDebug('value=', value);
            let fileSize = niceBytes(value.fileSize);
            htmlBody += `
                <tr>
                    <td data-order="${value.fileName}">
                        <a href="#" fileName="${value.fileName}">${value.fileName}</a>
                    </td>
                    <td>
                        ${fileSize}
                    </td>
                    <td>
            `;

            if(typeof value.elements === 'string') {
                htmlBody += value.elements;
            } else {
                htmlBody += value.elements.join('<br>');
            }

            htmlBody += '</td></tr>';
        });

        htmlBody += '</table>';
        $('#envInfoDiv').html(htmlBody);

        $('#envInfoTable').DataTable({
            "info":   false,
            "filter": false,
            "paging": false
        });

        $('#envInfoTable a').click(function(evt) {
            evt.preventDefault();
            let that = $(this);
            let f = that.attr('fileName');
            window.location = `${downloadURL}?fileName=${f}`;
            return false;
        });
    }

    QTL = function() {
        function init() {

            d3.queue()
                .defer(downloadEnvInfo)
                .defer(downloadDataSets)
                .await(function(error, envInfo, data) {
                    logDebug('envInfo=', envInfo);
                    logDebug('dataSetsData=', data);

                    if (error) {
                        logError(error);
                        if (!debugMode) { // redirect to error page if not in debug mode
                            window.location = pageErrorURL;
                        }
                        return;
                    }

                    if ((data.result === undefined) || (data.result.datasets.length === 0)) {
                        logError('data=', data);
                        if (!debugMode) { // redirect to error page if not in debug mode
                            window.location = pageErrorURL;
                        }
                        return;
                    }

                    global.resetDatasets();

                    buildEnvInfo(envInfo.result);

                    // Possible keys for the Ensembl release version.
                    const possibleKeys = ['ensembl.version', 'ensembl_version', 'ensembl.release', 'ensembl_release'];

                    // Find the first existing key and retrieve its value directly.
                    const keyFound = possibleKeys.find(key => key in data.result);
                    const ensembl_release = keyFound ? data.result[keyFound] : null;

                    // to display dropdown menu by alphabetical name
                    let datasets_dropdown = {};

                    $.each(data.result.datasets, function(dsi, ds) {
                        ds.gene_ids = {};
                        ds.protein_ids = {};
                        ds.phos_ids = {};
                        ds.phenotypes = {};

                        if ('ensembl_version' in ds) {
                            ds.ensembl_release  = ds['ensembl_version'];
                        } else if ('ensembl_release' in ds) {
                            ds.ensembl_release  = ds['ensembl_release'];
                        } else {
                            ds.ensembl_release = ensembl_release;
                        }

                        // TODO: Fix hardcoding
                        ds.ensembl_species = 'Mm';

                        // change the case so we don't have to throughout
                        ds.datatype = ds.datatype.toLowerCase();
                        logDebug('ds.datatype=', ds.datatype);

                        if (ds.datatype === 'mrna') {
                            // convert array to object (hash)
                            // ds.gene_ids = dictionary with just a 1
                            $.each(ds.annotations, function(index, element) {
                                ds.gene_ids[element['gene_id']] = 1;
                            });
                        } else if (ds.datatype === 'protein') {
                            // ds.gene_ids = dictionary with id and array of protein_ids
                            // ds.protein_ids = dictionary with id mapped to gene id
                            $.each(ds.annotations, function(index, element) {
                                if (!(element['gene_id'] in ds.gene_ids)) {
                                    ds.gene_ids[element['gene_id']] = {
                                        'id': element['gene_id'],
                                        'protein_ids':[]
                                    };
                                }
                                ds.protein_ids[element['protein_id']] = element['gene_id'];
                                ds.gene_ids[element['gene_id']].protein_ids.push(element['protein_id']);
                            });
                        } else if (ds.datatype === 'phos') {
                            // ds.gene_ids = dictionary with id and array of protein ids
                            // ds.protein_ids = dictionary with id and array of phos_ids and gene id
                            // ds.phos_ids = dictionary with id and gene_id and protein_id
                            $.each(ds.annotations, function(index, element) {
                                if (!(element['gene_id'] in ds.gene_ids)) {
                                    ds.gene_ids[element['gene_id']] = {
                                        'id': element['gene_id'],
                                        'protein_ids':[]
                                    };
                                }

                                if (!(element['protein_id'] in ds.protein_ids)) {
                                    ds.protein_ids[element['protein_id']] = {
                                        'id': element['protein_id'],
                                        'gene_id': element['gene_id'],
                                        'phos_ids':[]
                                    };

                                    ds.gene_ids[element['gene_id']].protein_ids.push(element['protein_id']);
                                }

                                ds.phos_ids[element['phos_id']] = {
                                    'gene_id': element['gene_id'],
                                    'protein_id': element['protein_id']
                                }

                                ds.protein_ids[element['protein_id']].phos_ids.push(element['phos_id']);

                            });
                        } else if ((ds.datatype === 'pheno') || (ds.datatype === 'phenotype')) {
                            ds.datatype = 'pheno';
                            logDebug(ds.id);
                            logDebug(ds.annotations);


                            $.each(ds.annotations, function(index, element) {
                                ds.phenotypes[element['data_name']] = element;
                            });
                        } else {
                            // TODO: handle error
                            logError('ERROR in dataset data:', ds);
                        }

                        // don't need the extra annotations laying around
                        delete ds.annotations;

                        datasets_dropdown[ds['display_name']] = ds.id;

                        global.addDataset(ds); 
                    });

                    datasets_dropdown = sortObj(datasets_dropdown);

                    

                    if (global.datasetExists(requestedDataSetID)) {
                        global.setDatasetID(requestedDataSetID);
                    } else {
                        global.setDatasetID(datasets_dropdown[Object.keys(datasets_dropdown)[0]]);
                    }

                    // the above if is working, but we need to think through all of
                    // the other ramifications of setting this dataset

                    configureCovarInfo(true);

                    logDebug('data.result.datasets.length=',data.result.datasets.length);

                    if (data.result.datasets.length === 1) {
                        // just show a menu item
                        let html = `<ul class="navbar-nav navbar-dark mr-auto">
                                        <li class="nav-item active" style="color:white">
                                            ${global.currentDataset['display_name']}
                                        </li>
                                        <li class="nav-item">
                                            <a class="font-italic text-primary nav-link" id="downloadInformation" data-toggle="modal" data-target="#downloadModal"><i class="fa-solid fa-download"></i> Download Data</a>
                                        </li>
                                    </ul>`;

                        $('#dataSetSelectMenu').append(html);
                        $('#correlationDatasetSelection').html(`${global.currentDataset['display_name']}`);
                        $('#correlationDatasetSelection').append(`<input type="hidden" id="correlationDatasetSelect" value="${global.currentDataset.id}"/>`);

                    } else if (data.result.datasets.length > 1) {
                        // show multiple menu items
                        let html = `<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerQTL" aria-controls="navbarTogglerQTL" aria-expanded="false" aria-label="Toggle navigation">
                                        <span class="navbar-toggler-icon"></span>
                                    </button>
                                    <div class="collapse navbar-dark navbar-collapse" id="navbarTogglerQTL">
                                        <span class="navbar-text text-white pr-2">
                                            ${navDataset} <i class="fas fa-long-arrow-alt-right"></i>
                                        </span>
                                        <form class="form-inline">
                                            <select data-style="btn-sm btn-light" class="selectpicker" id="datasetSelect">
                                            </select>
                                        </form>
                                        <ul class="navbar-nav mr-auto">
                                            <li class="nav-item">
                                                <a class="font-italic text-primary nav-link" id="downloadInformation" data-toggle="modal" data-target="#downloadModal"><i class="fa-solid fa-download"></i> Download Data</a>
                                            </li>
                                        </ul>
                                     </div>
                                    `;

                        $('#dataSetSelectMenu').append(html);

                        // display datasets by sorted name
                        for (let d in datasets_dropdown) {
                            let _id = datasets_dropdown[d];
                            if (global.datasetID === _id) {
                                $('#datasetSelect').append(`<option value="${_id}" selected>${d}</option>`);
                            } else {
                                $('#datasetSelect').append(`<option value="${_id}">${d}</option>`);
                            }
                        }

                        $('#datasetSelect').selectpicker();

                        $('#datasetSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                            let selected = $(this).find(':selected').val();
                            switchDataSet(selected);
                        });

                        // show multiple menu items
                        let htmlNew = `<select id="correlationDatasetSelect" data-width="100%" data-style="btn-secondary btn-sm" class="selectpicker">`;

                        for (let d in datasets_dropdown) {
                            let _id = datasets_dropdown[d];
                            if (global.datasetID === _id) {
                                htmlNew += `<option value="${_id}" selected>${d}</option>`;
                            } else {
                                htmlNew += `<option value="${_id}">${d}</option>`;
                            }
                        }
                        htmlNew += '</select>';

                        $('#correlationDatasetSelection').html(htmlNew);

                        $('#correlationDatasetSelect').selectpicker();

                        $('#correlationDatasetSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                            let selected = $(this).find(':selected').val();
                            let interactiveCovariate = $('#interactiveCovarCorrelation').find(':selected').val();
                            switchCorrelationDataSet(selected, interactiveCovariate);
                        });
                    }

                    global.ENSIMPL = new ensimpl({
                        greedy: true,
                        search_limit: 100,
                        search_release: global.currentDataset.ensembl_release,
                        search_species: global.currentDataset.ensembl_species,
                    });

                    d3.queue()
                        .defer(downloadChromosomes, global.currentDataset.ensembl_release, global.currentDataset.ensembl_species, global.currentDataset.id)
                        .defer(downloadLODPeaks, global.datasetID)
                        .await(function(errorPeaks, chromosomes, lodPeaks) {
                            global.currentDataset.chromosomes = {
                                'idx': [],
                                'chr': {},
                                'contigs':[]
                            };


                            global.currentDataset.ensembl = {
                                'species': chromosomes.meta.species,
                                'assembly': chromosomes.meta.assembly,
                                'assembly_patch': chromosomes.meta.assembly_patch,
                                'release': chromosomes.meta.release,
                                'url': chromosomes.meta.url
                            };

                            
                            let start = 1;
                            let end = 0;

                            $.each(chromosomes.chromosomes, function(index, element) {
                                if (global.CHROMOSOMES.indexOf(element.chromosome) !== -1) {
                                    let chrom = element;

                                    start = end + 1;
                                    end += chrom.length;

                                    chrom.start = start;
                                    chrom.end = end;
                                    chrom.mid = chrom.start + Math.ceil((chrom.end - chrom.start) / 2);

                                    global.currentDataset.chromosomes.idx.push(chrom);
                                    global.currentDataset.chromosomes.chr[element.chromosome] = chrom;
                                    global.currentDataset.chromosomes.contigs.push({
                                        "name": chrom.chromosome,
                                        "size": chrom.length,
                                    });
                                }
                            });

                            global.currentDataset.chromosomes.totalLength = end;
                            global.currentDataset.lodpeaks = lodPeaks.result;

                            setDataSet(global.datasetID, true);

                            logDebug('Hiding loading screen');
                            window.loading_screen.finish();
                        });

                    // download all the other load peaks from all the datasets except the current one
                    // we do this in the background to gain some performance
                    let q = d3.queue();
                    logDebug('Downloading the peaks and chromosomes...');

                    $.each(global.DATASETS, function(key, value) {
                        if (key !== global.datasetID) {
                            q.defer(downloadLODPeaks, key);
                            q.defer(downloadChromosomes, global.getDataset(key).ensembl_release, global.getDataset(key).ensembl_species, key);
                        }
                    });

                    q.awaitAll(function(errorAll, results) {
                        // TODO: handle error
                        $.each(results, function(key, value) {
                            if ('chromosomes' in value) {
                                let _id = value['_description'].split(' ')[1];
                                global.getDataset(_id).chromosomes = {
                                    'idx': [],
                                    'chr': {},
                                    'contigs': []
                                };

                                global.getDataset(_id).ensembl = {
                                    'species': value.meta.species,
                                    'assembly': value.meta.assembly,
                                    'assembly_patch': value.meta.assembly_patch,
                                    'release': value.meta.release,
                                    'url': value.meta.url
                                };

                                let start = 1;
                                let end = 0;

                                $.each(value.chromosomes, function(index, element) {
                                    if (global.CHROMOSOMES.indexOf(element.chromosome) !== -1) {
                                        let chrom = element;

                                        start = end + 1;
                                        end += chrom.length;

                                        chrom.start = start;
                                        chrom.end = end;
                                        chrom.mid = chrom.start + Math.ceil((chrom.end - chrom.start) / 2);

                                        global.getDataset(_id).chromosomes.idx.push(chrom);
                                        global.getDataset(_id).chromosomes.chr[element.chromosome] = chrom;
                                        global.getDataset(_id).chromosomes.contigs.push({
                                            "name": chrom.chromosome,
                                            "size": chrom.length,
                                        });
                                    }
                                });

                                global.getDataset(_id).chromosomes.totalLength = end;
                                logDebug('global.getDataset(_id).chromosomes=', global.getDataset(_id).chromosomes);

                            } else {
                                global.getDataset(value.parameters.dataset).lodpeaks = value.result;
                            }
                        });
                    });
                });
            }
        

        

        function updateCorrelateDataSet(groupID) {
            // send GET request to status URL
            logDebug('updateCorrelateDataSet');
            logDebug(groupID);

            if (global.runningTask) {
                let statusURL = statusBaseURL + groupID;
                $.ajax({
                    type: 'GET',
                    url: statusURL,
                    retries: 3,
                    retryInterval: 1000,
                    success: function (data, status, request) {
                        logDebug('DATA=======', data);
                        if (data.status === 'DONE') {
                            if ('error' in data) {
                                // MAJOR ERROR
                                let message = `Unfortunately, there was a problem contacting the server.  Please try again.`;
                                stopTask();
                                showErrorMessage(message, null);
                            } else if (data.number_tasks_errors !== 0) {
                                let message = `Unfortunately, we encountered an error.  Please try again.`;
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if ('error' in value) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.error}<br>`);
                                    }
                                });

                                stopTask();
                                showErrorMessage(message, errorMessages);
                            } else if (data.number_tasks_errors === 0) {
                                // check to make sure the status codes are good
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if (value.status_code !== 200) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.response.error}<br>`);
                                    }
                                });

                                if (errorMessages !== '') {
                                    let message = `Unfortunately, there was a problem calculating the Correlation Data.`;
                                    stopTask();
                                    showErrorMessage(message, errorMessages);
                                } else {
                                    displayCorrelation(data.response_data.correlation.response.result);
                                    stopTask();
                                }
                            }
                        } else {
                            // rerun in 1 seconds
                            logDebug('Not done, keep checking...');
                            setTimeout(function () {
                                updateCorrelateDataSet(groupID);
                            }, 1000);  // TODO: change to 1000 (1 second)
                        }
                    }
                });
            } else {
                // TODO: cleanup
                logDebug('canceling');
                let cancelURL = `${cancelBaseURL}${groupID}`;
                $.getJSON(cancelURL, function (data) {
                    logDebug(data);
                    global.chartCorrelation = null;
                    $('#correlationDataTable').html('');
                    $('#plotCorrelation').html('');
                });
            }

        }

        function switchCorrelationDataSet(datasetID, interactiveCovariate) {
            $('#plotCorrelation').html('');
            $('#correlationDataTable').html('');
            global.chartCorrelation = null;
            global.correlationDatasetID = datasetID;

            let currentID = '';

            if (global.currentDataset.datatype === 'mrna') {
                currentID = global.geneID;
            } else if (global.currentDataset.datatype === 'protein') {
                currentID = global.proteinID;
            } else if (global.currentDataset.datatype === 'phos') {
                currentID = global.phosID;
            } else if (global.currentDataset.datatype === 'pheno') {
                currentID = global.phenotypeID;
            } else {
                // TODO: handle error
                logError('MAJOR PROBLEM');
            }


            let urlCorrelation = `${rBaseURL}/correlation?dataset=${global.datasetID}&id=${currentID}&dataset_correlate=${datasetID}`;

            if ((interactiveCovariate !== undefined) &&
                (interactiveCovariate !== null) &&
                (interactiveCovariate !== 'none')) {
                urlCorrelation += `&intcovar=${interactiveCovariate}`;
            }

            let submitData = {
                urls:[{
                    url_id: 'correlation',
                    url: urlCorrelation
                }]};

            startTask();

            $.ajax({
                type: 'POST',
                url: submitURL,
                contentType: 'application/json',
                data: JSON.stringify(submitData),
                retries: 3,
                retryInterval: 1000,
                success: function(data, status, request) {
                    global.runningTask = true;
                    logDebug('data=', data);
                    logDebug('status=', status);
                    logDebug('request=', request);
                    logDebug('data.group_id=', data.group_id);
                    updateCorrelateDataSet(data.group_id);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showErrorMessage(errorThrown, textStatus);
                }
            });
        }

        /**
         * Switch the datasets.
         *
         * @param {string} datasetID - the dataset identifier
         */
        function switchDataSet(datasetID) {
            global.datasetID = datasetID;

            let html = `<div class="col">
                            <div class="jumbotron jumbotron-fluid" style="background: none">
                                <div class="container">
                                    <h1 class="display-3">${mainTitle}</h1>
                                    <p class="lead">Please search for a term of interest.</p>
                                </div>
                            </div>
                        </div>`;

            $('#divWelcomeMesage').html(html);

            $('#divItemInfo').addClass('invisible').removeClass('visible');
            $('#divLOD').addClass('invisible').removeClass('visible');
            $('#divSecondRow').addClass('invisible').removeClass('visible');
            $('#divProfileCorrelation').addClass('invisible').removeClass('visible');
            $('#div_current_item_information_header').html('');
            $('#div_current_item_information_body').html('');
            $('#divProfilePlotOptions').html('');

            configureCovarInfo(true);

            setDataSet(datasetID, true);
        }

        /**
         * Display the gene information.
         * @param {Object} geneData - gene information
         */
        function setDataSet(datasetID, force) {
            logDebug('setDataSet=', datasetID);

            if (!(force) && (global.datasetID === datasetID)) {
                logDebug('Same dataset selected, do nothing');
                return;
            }

            if (!isEmpty(global.currentDataset.lodpeaks)) {
                generateLODPeaksHTML();
            }


            let ds = global.getDataset(datasetID);
            global.setDatasetID(datasetID);

            $('#divGenome').html(`<b>${ds.display_name}</b> is utilizing Ensembl Release <b>${ds.ensembl.release}</b>, Genome <b>${ds.ensembl.assembly_patch}</b> <div style='height: 10px'></div>`);

            // clear LOD Plot
            // TODO: clear LOD PLOT, Profile PLOT
            global.chartCorrelation = null;
            $('#lodPlotChart').html('');
            $('#lodPlotChartCovariateFull').html('');
            $('#lodPlotChartCovariateDiff').html('');
            $('#correlationCovariateSelectionText').addClass('hidden').removeClass('visible');
            $('#correlationImputation').html('');

            resetSecondaryPlots();

            // make tabs invisible
            $('#navGene').hide();
            $('#navPheno').hide();
            if (isEmpty(global.currentDataset.lodpeaks)) {
                $('#navLodPeaks').hide();
            } else {
                $('#navLodPeaks').show();
            }


                        // show correlation
            if (isEmpty(ds['covar_info'])) {
                $('#profilePlot a[href="#tabCorrelation"]').tab('show');
                $('#navProfile').hide();
            } else {
                $('#profilePlot a[href="#tabProfile"]').tab('show');
                $('#navProfile').show();
            }


            // show the correct tab
            if ((ds.datatype === 'mrna') || (ds.datatype === 'protein') || (ds.datatype === 'phos')) {
                $('#navGene').show();
                $('#navGene').tab('show');

                // show some secondary plots
                $('#navPlotMediation').show();

                // reset the screen
                $('#searchResultsDiv').html('');
                $('#searchResultsTableInfo').html('');

            } else if (ds.datatype === 'pheno') {
                $('#navPheno').show();
                $('#navPheno').tab('show');

                // hide some secondary plots

                // phenotype data can only mediate against mrna or protein (not itself)
                let showMed = false;
                $.each(global.DATASETS, function(k, v) {
                    if ((v.datatype === 'mrna') || (v.datatype === 'protein') || (v.datatype === 'phos')) {
                        showMed = true;
                    }
                });

                if (showMed) {
                    $('#navPlotMediation').show();
                } else {
                    $('#navPlotMediation').hide();
                }

                $('#searchPheno').html('');
                $('#searchPhenoCategoryText').html('');
                $('#searchPhenoCategory').html('');
                $('#searchPhenoResultsInfo').html('');
                $('#searchPhenoResultsDiv').html('');

                //let numResults = ds.phenotypes.length;

                // transform the phenotypes into a different structure
                let categories = new Set([]);
                let newPhenotypes = [];
                $.each(ds.phenotypes, function(index, element) {
                    if ((element['is_pheno']) && (element['is_numeric'])) {
                        categories.add(element.category);
                        element.display = element['short_name'];
                        newPhenotypes.push({phenotype_id: element['data_name'], // use for id
                                            phenotype: element['short_name'],   // display on screen
                                            category: element.category,
                                            desc: element.description});
                    }
                });

                // build the search area
                if (categories.size === 0) {
                    logError('No categories - ERROR');
                } else {
                    $('#searchPheno').html('<input type="text" id="searchTermPheno" name="searchTermPheno" class="form-control" placeholder="Please enter a phenotype to filter results...">');

                    // build the phenotypes table
                    $('#searchPhenoResultsDiv').html(`<table id="phenotypesTable" class="table table-striped table-hover table-sm table-bordered">
                                                <thead>
                                                    <th style="background-color: #20a8d8" data-dynatable-sorts="Phenotype">Phenotype</th>
                                                    <th style="display: none">category</th>
                                                    <th style="display: none">desc</th>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>`);

                    global.phenoDynaTable = $('#phenotypesTable')
                        .bind('dynatable:init', function(e, dynatable) {
                            dynatable.queries.functions.phenotype = function(record, queryValue) {
                                if ((record.phenotype.toLowerCase().indexOf(queryValue.toLowerCase()) !== -1) ||
                                    (record.desc.toLowerCase().indexOf(queryValue.toLowerCase()) !== -1)) {
                                    return true;
                                }
                            };
                        }).dynatable({
                            dataset: {
                                records: newPhenotypes,
                            },
                            features: {
                                paginate: false,
                                pushState: false,
                                recordCount: true,
                                sort: true,
                                search: false,
                            },
                            inputs: {
                                recordCountPlacement: 'before',
                            },
                            writers: {
                                _rowWriter: function(rowIndex, record, columns, cellWriter) {
                                    return `<tr><td><span class="font-weight-bold"><a href="#" phenotypeid="${record.phenotype_id}">${record.phenotype}</a></span><br><span class="font-italic">${record.category}</span><br><span class="font-weight-light">${record.desc}</span></td></tr>`;
                                }
                            },
                        }).data('dynatable');

                    // build the category select, if more than 1 category
                    categories = Array.from(categories);

                    if (categories.length > 1) {
                        $('#searchPhenoCategoryText').html('Category Filter');

                        let htmlOptions = '<select id="phenoCategorySelect" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">';
                        htmlOptions += '<option>All</option>';
                        $.each(categories, function (i, val) {
                            htmlOptions += `<option>${val}</option>`;
                        });
                        htmlOptions += '</select>';
                        $('#searchPhenoCategory').html(htmlOptions);

                        $('#phenoCategorySelect').selectpicker();

                        $('#phenoCategorySelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                            let selected = $(this).find(':selected').val();
                            if (selected === 'All') {
                                global.phenoDynaTable.queries.remove('category');
                            } else {
                                global.phenoDynaTable.queries.add('category', selected);
                            }

                            global.phenoDynaTable.process();
                            $('#phenotypesTable tbody a').on('click', function (evt) {
                                evt.preventDefault();
                                let that = $(this);
                                selectPhenotype(that.attr('phenotypeid'), global.datasetID, $('#interactiveCovarLODS').val());
                                return false;
                            });
                        });
                    }

                    $('#searchTermPheno').keyup(function (event) {
                        if ( event.which === 13 ) {
                            event.preventDefault();
                        }
                        let q = $(this).val();

                        if (q === '') {
                            q = undefined;
                        }

                        if (q) {
                            global.phenoDynaTable.queries.add('phenotype', q);
                        } else {
                            logDebug('removing');
                            global.phenoDynaTable.queries.remove('phenotype');
                        }

                        logDebug('global.phenoDynaTable.process()');
                        global.phenoDynaTable.process();
                        $('#phenotypesTable tbody a').on('click', function (evt) {
                            evt.preventDefault();
                            let that = $(this);
                            selectPhenotype(that.attr('phenotypeid'), global.datasetID, $('#interactiveCovarLODS').val());
                            return false;
                        });

                    });

                    $('#phenotypesTable tbody a').on('click', function (evt) {
                        evt.preventDefault();
                        let that = $(this);
                        selectPhenotype(that.attr('phenotypeid'), global.datasetID, $('#interactiveCovarLODS').val());
                        return false;
                    });
                }

            } else {
                // TODO: handle error
                logDebug('ERROR in setDataSet:', ds);
            }


            // hide or show the mediation based upon if there are datasets that can mediate against
            let allDS = [];
            $.each(global.DATASETS, function(key, value) {
                if (value.datatype !== 'pheno') {
                    allDS.push(value);
                }
            });

            $('#divMediationSelect').html('');

            if (allDS.length === 1) {
                $('#divMediationSelect').html(`<p class="font-weight-bold">Mediating against: </p>${allDS[0]['display_name']}`);
                $('#divMediationSelect').append(`<input type="hidden" id="dsMediateAgainstID" value="${allDS[0].id}"/>`);
            } else if (allDS.length > 1) {

                let htmlMediate = `<div class="row">
                                       <div class="col-auto align-self-center font-weight-bold">
                                           Mediate Against
                                      </div>
                                      <div class="col">
                                          <select id="dsMediateAgainstID" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">`;

                $.each(allDS, function(idx, elem) {
                    logDebug(idx, elem);
                    if (elem.id === datasetID) {
                        htmlMediate += `<option selected value="${elem.id}">${elem['display_name']}</option>`;
                    } else {
                        htmlMediate += `<option value="${elem.id}">${elem['display_name']}</option>`;
                    }
                });
                htmlMediate += '</select></div></div>';

                $('#divMediationSelect').html(htmlMediate);
                $('#dsMediateAgainstID').selectpicker();
            }
        }

       

        /**
         * Perform gene search.
         */
        function findGene(searchVal) {
            //let button = $('#btnGo');
            let term = $('#searchTerm');
            term.disable(true);
            //button.button('loading');

            if (searchVal.length === 0) {
                term.focus();
                term.disable(false);
                //button.button('reset');
                return;
            }

            let options = {
                species: global.currentDataset.ensembl_species,
                release: global.currentDataset.ensembl_release,
                limit: 100,
                greedy: true
            };

            logDebug(options);

            startTask();
            global.ENSIMPL.search(searchVal, options, searchCallback);
        }

        /**
         * Populate the search results.
         */
        function searchCallback() {
            logDebug(global.ENSIMPL);

            if (global.ENSIMPL.response.result.matches === null) {
                $('#searchResultsDiv').html('');
                $('#btnGo').button('reset');
                $('#searchTerm').disable(false);
                $('#searchResultsTableInfo').html('No results found');
                stopTask();
                return;
            }

            let response = global.ENSIMPL.response;
            let currentDataSet = global.currentDataset;
            let searchResults = [];
            let searchResultsObj = {};


            $.each(response.result.matches, function(idx, match) {

                match['match'] = match.ensembl_gene_id in currentDataSet.gene_ids;
                match['datatype'] = currentDataSet.datatype;

                if ((currentDataSet.datatype === 'protein') && (match.match)) {
                    match['protein_ids'] = currentDataSet.gene_ids[match.ensembl_gene_id].protein_ids;
                } else if ((currentDataSet.datatype === 'phos')  && (match.match)) {
                    match['protein_ids'] = currentDataSet.gene_ids[match.ensembl_gene_id].protein_ids;
                }

                searchResults.push(match);
                searchResultsObj[match.ensembl_gene_id] = match;
            });

            // build the results table
            $('#searchResultsDiv').html(`<table id="searchResultsTable" class="table table-striped table-hover table-sm table-bordered" style="font-size:0.85rem">
                                        <thead>
<th data-dynatable-no-sort></th>
                                            <th data-dynatable-sorts="ID">ID</th>
<th >Symbol</th>
<!--
                                            <th style="display: none">category</th>
                                            <th style="display: none">desc</th>
//--->
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>`);

            $('#searchResultsTable')
                .dynatable({
                    dataset: {
                        records: searchResults,
                    },
                    features: {
                        paginate: false,
                        pushState: false,
                        recordCount: true,
                        sort: false,
                        search: false,
                    },
                    inputs: {
                        recordCountPlacement: 'before',
                    },
                    writers: {
                        _rowWriter: function(rowIndex, record, columns, cellWriter) {
                            let html = `<tr><td><i id="matchInfo" geneID="${record.ensembl_gene_id}" class="fas fa-info-circle"></i></td>`;

                            if (record.datatype === 'mrna') {
                                if (record.match) {
                                    html += `<td><span><a href="#" geneID="${record.ensembl_gene_id}">${record.ensembl_gene_id}</a></span></td>`;
                                } else {
                                    html += `<td><span>${record.ensembl_gene_id}</span></td>`;
                                }

                            } else if (record.datatype === 'protein') {
                                html += `<td style="white-space: nowrap;"><span>${record.ensembl_gene_id}</span>`;

                                if (record.match) {
                                    html += '<br/>';
                                    let proteins = [];
                                    for (let p in record.protein_ids) {
                                        proteins.push(`<span style="padding-left: 5px;"><i class="fa-solid fa-turn-up fa-rotate-90"></i> <a href="#" geneID="${record.ensembl_gene_id}" proteinID="${record.protein_ids[p]}">${record.protein_ids[p]}</a></span>`);
                                    }
                                    html += proteins.join('<br/>');
                                }

                                html += '</td>';
                            } else if (record.datatype === 'phos') {
                                html += `<td style="white-space: nowrap;"><span>${record.ensembl_gene_id}</span>`;

                                if (record.match) {
                                    html += '<br/>';
                                    let proteins = [];
                                    for (let p in record.protein_ids) {
                                        let protein_id = record.protein_ids[p];

                                        let phos = [];
                                        for (let j in currentDataSet.protein_ids[protein_id]?.phos_ids) {
                                            let ph = currentDataSet.protein_ids[protein_id].phos_ids[j];
                                            let ph_id = ph.split('_')[1];
                                            phos.push(`<span style="padding-left: 25px;"><i class="fa-solid fa-turn-up fa-rotate-90"></i> <a href="#" geneID="${record.ensembl_gene_id}" proteinID="${protein_id}" phosID="${ph}">${ph_id}</a>`);
                                        }

                                        proteins.push(`<span style="padding-left: 5px;"><i class="fa-solid fa-turn-up fa-rotate-90"></i> ${protein_id}</span><br/>` + phos.join('<br/>'));
                                    }
                                    html += proteins.join('<br/>');
                                }



                                html += '</td>';
                            }

                            html += `<td>${record.symbol}</td></tr>`;

                            return html;
                        }
                    },
                }).data('dynatable');


            $('#searchResultsTable a').on('click', function (evt) {
                let that = $(this);
                evt.preventDefault();
                selectGeneProtein(that.attr('geneid'), that.attr('proteinid'), that.attr('phosid'), global.datasetID, $('#interactiveCovarLODS').val());
                return false;
            });

            setTimeout(function () {
                $('[id="matchInfo"]').each(function (idx, elem) {
                    $(this).popover({
                        placement: 'right',
                        html: true,
                        trigger: 'hover',
                        container: 'body',
                        sanitize: false,
                        content: function () {

                            let d = searchResultsObj[this.getAttribute('geneid')];


                            let h = `<table class="table table-sm">
                                        <tr><td><strong>Symbol</strong> </td><td>${d.symbol}</td></tr>
                                        <tr><td><strong>Location</strong> </td><td>${d.chromosome}:${d.position_start.toLocaleString()}-${d.position_end.toLocaleString()}</td></tr>
                                        <tr><td><strong>Name</strong> </td><td>${d.name}</td></tr>
                                        <tr><td><strong>Synonyms</strong> </td><td>`;

                            let s = d.synonyms;
                            if (s) {
                                if (s.length > 5) {
                                    let s2 = s.slice(1, 6);
                                    h += s2.join('<br>');
                                    h += '<br><i>(' + (s.length - s2.length) + ' more synonyms)</i>';
                                } else {
                                    h += s.join('<br>');
                                }
                            }
                            h += `</td></tr>
                                  <tr><td><strong>Match Reason</strong> </td><td>${d.match_reason}</td></tr>
                                  <tr><td><strong>Match Value</strong> </td><td>${d.match_value}</td></tr>
                                  </table>`;

                            return h;
                        }
                    });
                });

            });
            $('#btnGo').button('reset');
            $('#searchTerm').disable(false);

            stopTask();

            // simulate a click event if the search yields only 1 result
            if ($('#searchResultsTable a').length === 1) {
                $('#searchResultsTable a')[0].click();
            }

            $('#searchResultsTable').DataTable({
                "info": false,
                "filter": false,
                "scrollY": "300px",
                "false": true,
                "order": [],
                "paging": false,
            });
        }

        function generateSecondaryPlot(plot, id, markerID, chromosome, location, covar) {
            logDebug('Generating Secondary Plot');
            if (plot === 'navPlotMediation') {
                generateMediationPlot(id, markerID, covar);
            } else if (plot === 'navPlotEffect') {
                generateEffectPlot(id, chromosome, covar);
            } else if (plot === 'navPlotSNPs') {
                generateSNPAssocPlot(id, chromosome, location, covar);
            } else {
                logError('Unknown plot ', plot);
            }
        }


        function exportLODChartData(id, data, covar, exportName) {
            let csvContent = '"id","chromosome","position","lod"\n';
            $.each(data, function(k, v) {
                csvContent += `"${v.id}","${v.chr}",${v.chrPos},${v.y}\n`;
            });

            if (exportName !== null) {
                downloadCSV(csvContent, `${id}_LOD_${covar}_${exportName}.csv`, 'text/csv;encoding:utf-8');
            } else {
                downloadCSV(csvContent, `${id}_LOD.csv`, 'text/csv;encoding:utf-8');
            }
        }

        /**
         * Plot the LOD chart.
         *
         * @param {Array} dataLOD Array of objects containing LOD scores.
         * @param {string} covar The covariate (additive) for default.
         * @param {Array} dataDiff Array of covariate objects containing LOD score.
         */
        function plotLODChart(dataLOD, covar, dataDiff) {
            // "1_3000000", "1", 3, 1.4975
            let maxLOD = -Infinity;
            let minLOD = Infinity;
            let xAxisTitle = '';
            let xAxisSubTitle = '';
            let newLodData = [];
            let currentID = null;
            let isCovar = false;
            let renderTo = 'lodPlotChart';
            let lineColor = 'black';
            let isFull = true;
            let exportName = null;

            if (covar !== 'additive') {
                isCovar = true;
                renderTo = 'lodPlotChartCovariateFull';
                exportName = 'FULL';

                if (dataDiff !== null) {
                    lineColor = '#146582';
                    isFull = false;
                    renderTo = 'lodPlotChartCovariateDiff';
                    exportName = 'DIFF';
                }
            } else {
                //
            }

            logDebug('dataLOD=', dataLOD);
            logDebug('covar=', covar);
            logDebug('dataDiff=', dataDiff);
            logDebug('renderTo=', renderTo);

            if (dataLOD !== null) {
                maxLOD = dataLOD[0][3];
                minLOD = -2;

                if (global.currentDataset.datatype === 'mrna') {
                    currentID = global.geneID;
                    xAxisTitle = global.geneID + ' (' + global.gene.gene[global.geneID].symbol + ')';
                } else if (global.currentDataset.datatype === 'protein') {
                    currentID = global.proteinID;
                    xAxisTitle = global.proteinID + ' (' + global.gene.gene[global.geneID].symbol + ')';
                } else if (global.currentDataset.datatype === 'phos') {
                    currentID = global.phosID;
                    xAxisTitle = global.phosID;
                } else if (global.currentDataset.datatype === 'pheno') {
                    // pheno
                    xAxisTitle = global.phenotypeID;
                    currentID = global.phenotypeID;
                    if (currentID !== global.currentDataset.phenotypes[currentID]['short_name']) {
                        xAxisTitle += (' (' + global.currentDataset.phenotypes[currentID]['short_name'] + ')');
                    }
                } else {
                    // TODO: handle error
                    logError('MAJOR PROBLEM');
                }

                if (isCovar) {
                    xAxisSubTitle = `${covar} ${exportName}`;
                }

                $.each(dataLOD, function(index, element) {
                    //
                    // element = {"[id]","[chr]",[position],[data]}
                    //
                    if (element[1] in global.currentDataset.chromosomes.chr) {

                        let chr = global.currentDataset.chromosomes.chr[element[1]];
                        let x = chr.start + element[2];
                        let y = element[3];

                        if (!isFull) {
                            y = y - dataDiff[index][3];
                        }

                        let d = {
                            x: x,
                            y: y,
                            id: element[0],
                            text: element[3],
                            chr: chr.chromosome,
                            chrPos: element[2],
                            covar: covar
                        };

                        newLodData.push(d);
                        maxLOD = Math.max(element[3], maxLOD);
                    }
                });

                logDebug('MAX LOD = ', maxLOD);

                maxLOD = Math.ceil(maxLOD) + 1;

                logDebug('MAX LOD = ', maxLOD);
            }

            newLodData.sort(compareX);

            logDebug('newLodData=', newLodData);

            //
            // build the vertical chromosome bars
            //
            let chromosomeAxisVals = [];
            let chromosomeAxisText = {};
            let chromosomeBands = [];

            $.each(global.currentDataset.chromosomes.idx, function(index, element) {

                chromosomeAxisVals.push(element.mid);
                chromosomeAxisText[element.mid] = element.chromosome;

                // TODO: style this
                let fillColor = '#eeeeee';
                if ((index % 2) === 1) {
                    chromosomeBands.push({
                        color: fillColor,
                        from: element.start,
                        to: element.end
                    });

                    logDebug(fillColor);
                }
            });

            let plotShapes = [];
            let plotAnnotations = [];
            let _plotLines = [];

            if (plotLODLines) {
                // Generate the lineVals array from plotLODLines
                let lineVals = plotLODLines.map(l => ({
                    val: l.val,
                    color: l.color,
                    text: l.text
                }));

                // Generate the _plotLines array for plotting configurations
                _plotLines = plotLODLines.map(l => ({
                    value: l.val,
                    color: l.color,
                    zIndex: 5,
                    width: 2,
                    label: {
                        text: l.text,
                        align: 'right'
                    }
                }));
                
                // Create shapes and annotations based on lineVals
                lineVals.forEach(line => {
                    plotShapes.push({
                        type: 'line',
                        xref: 'paper',
                        x0: 0,
                        y0: line.val,
                        x1: 1,
                        y1: line.val,
                        line: {
                            color: line.color,
                            width: 1.5
                        },
                        layer: 'above',
                    });

                    plotAnnotations.push({
                        x: 1,
                        y: line.val,
                        xref: 'paper',
                        yref: 'y',
                        text: line.text,
                        xanchor: 'left',
                        yanchor: 'middle',
                        showarrow: false,
                    });
                });
            }


            let exporting = appendExportButton('Download CSV', function() {
                exportLODChartData(currentID, newLodData, covar, exportName);
            });

            exporting.filename = currentID + '_LOD';

            if (isCovar) {
                exporting.filename = `${currentID}_LOD_${covar}_${exportName}`;
            }


            let series = {
                    boostThreshold: 1,
                    color: lineColor,
                    data: newLodData,
                    name: covar,
                    lineWidth: 0.5,
                    marker: {
                       enabled: false
                    },
                    showInLegend: false,
                    turboThreshold: 0,
                    type: 'line',
                };

            let chartLOD = Highcharts.chart({
                boost: {},
                chart: {
                    alignTicks: false,
                    renderTo: renderTo,
                    zoomType: 'x',
                    events: {
                        click: function(event) {
                            if (event.target.tagName === 'tspan') {
                                // do not generate secondary plot for user clicking "Reset zoom"
                                return;
                            }

                            let plot = $('#secondaryPlotTabs').find('.active').attr('id');
                            let markerID = this.hoverPoint.id;
                            let chromosome = this.hoverPoint.chr;
                            let location = this.hoverPoint.chrPos;
                            let covar = this.hoverPoint.covar;


                            logDebug('event', markerID, chromosome, location, this.hoverPoint.covar);

                            generateSecondaryPlot(plot, currentID, markerID, chromosome, location, covar);
                        }
                    }
                },
                exporting: exporting,
                plotOptions: {
                    series: {
                        findNearestPointBy: 'xy',
                        cursor: 'pointer',
                        events: {
                            click: function(event) {
                                logDebug('plotOptions, series', event);

                                let plot = $('#secondaryPlotTabs').find('.active').attr('id');
                                let markerID = event.point.id;
                                let chromosome = event.point.chr;
                                let location = event.point.chrPos;
                                let covar = event.point.covar;

                                logDebug('series', markerID, chromosome, location, event.point.covar);

                                generateSecondaryPlot(plot, currentID, markerID, chromosome, location, covar);

                            }
                        }
                    }
                },

                series: [series],
                title: {
                    text: xAxisTitle
                },
                subtitle: {
                    text: xAxisSubTitle
                },
                tooltip: {
                    outside: true,
                    /*
                    positioner: function(labelWidth, labelHeight, point) {
                        let tooltipX, tooltipY;
                        let chart = chartLOD;

                        if (point.plotX + labelWidth > chart.plotWidth) {
                            tooltipX = point.plotX + chart.plotLeft - labelWidth - 20;
                        } else {
                            tooltipX = point.plotX + chart.plotLeft + 20;
                        }

                        if (point.plotY + labelHeight > chart.plotHeight) {
                            tooltipY = point.plotY + chart.plotTop - labelHeight - 20;
                        } else {
                            tooltipY = point.plotY + chart.plotTop - 20;
                        }

                        return {
                            x: tooltipX,
                            y: tooltipY
                        };
                    },
                    */
                    useHTML: true,
                    formatter: function () {
                        let p = this.point;
                        return `<b>${p.id}</b><br/>LOD: ${p.y}<br/>Position: ${p.chr}:${p.chrPos.toLocaleString()}`;
                    }
                },
                xAxis: {
                    opposite: true,
                    gridLineWidth: 0,
                    labels: {
                        formatter: function () {
                            return chromosomeAxisText[this.value];
                        }
                    },
                    tickPositions: chromosomeAxisVals,
                    plotBands: chromosomeBands,

                },
                yAxis: {
                    min: 0,
                    max: maxLOD,
                    title: {
                        text: 'LOD'
                    },
                    plotLines: _plotLines
                },
            });
        }


        function configureCovarInfo(resetPeaks) {
            logDebug('configureCovarInfo', resetPeaks);

            // current dataset
            let ds = global.currentDataset;

            logDebug("ds['covar_info'] = ", ds['covar_info']);

            if (isEmpty(ds['covar_info'])) {
                logDebug('NO COVAR INFO');

                // configure the lod peaks covariate selections
                if (resetPeaks) {
                    $('#divInteractiveCovariatesPeaks').html(`<input type="hidden" id="interactiveCovarPeaks" value="additive"/>`);
                }

                // configure the profile plot covariate selections
                // currently the profile plot tab is hidden when no covariates available
                let profilePlotOptionsHTML = `
                    <input type="hidden" id="factorSeries" value="additive"/>
                    <input type="hidden" id="factorSeriesCorrelation" value="additive"/>
                    <select id="factorSeries" style="hidden"><option value="" selected></option></select>;
                `;
                $('#divProfilePlotOptions').html(profilePlotOptionsHTML);

                // configure the lod plot covariate selections
                $('#divInteractiveCovariatesLOD').html(`<input type="hidden" id="interactiveCovarLODS" value="additive"/>`);

                // configure the correlation plot covariate selections
                $('#correlationCovariateSelectionText').addClass('hidden').removeClass('visible');
                $('#correlationCovariateSelection').html('<input type="hidden" id="interactiveCovarCorrelation" value="additive"/>');
                $('#correlationImputation').html('');

                // hide the correlation color select
                $("#divCorrelationCovars").addClass('hidden').removeClass('visible');

                logDebug('configureCovarInfo RETURNING');
            } else {

                // configure the profile plot covariate selections

                let profilePlotOptionsHTML = `
                    <div class="col">
                    <div class="row">
                        <div class="col font-weight-bold">
                            Select your factors
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div id="factor-view-select-wrapper">
                                <select id="factor-view-select" multiple="multiple">
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row row-spacer"></div>

                    <div class="row">
                        <div class="col font-weight-bold">
                            Select a series to color
                        </div>
                    </div>

                    <div class="row">
                        <div class="col" id="divFactorSeries">
                        </div>
                    </div>

                    <div class="row row-spacer"></div>
                    </div>
                `;

                $('#divProfilePlotOptions').html(profilePlotOptionsHTML);

                global.orderCount = ds['covar_info'].length;
                logDebug('global.orderCount=', global.orderCount);

                $('#factor-view-select').multiselect({
                    onChange: function (option, checked) {
                        if (checked) {
                            global.orderCount++;
                            $(option).attr('order', global.orderCount);
                        } else {
                            $(option).attr('order', '');
                        }

                        if (global.currentDataset.datatype === 'mrna') {
                            plotProfile(global.geneID);
                        } else if (global.currentDataset.datatype === 'protein') {
                            plotProfile(global.proteinID);
                        } else if (global.currentDataset.datatype === 'phos') {
                            plotProfile(global.phosID);
                        } else if (global.currentDataset.datatype === 'pheno') {
                            plotProfile(global.phenotypeID);
                        } else {
                            // TODO: major error
                            logError('MAJOR ERROR');
                        }

                    },
                    maxHeight: 400,
                    dropUp: false,
                    buttonWidth: '100%',
                    buttonClass: 'text-left btn btn-sm btn-secondary',
                    buttonText: function (options) {
                        if (options.length === 0) {
                            return 'None selected';
                        } else {
                            let selected = [];

                            options.each(function () {
                                selected.push([$(this).text(), $(this).attr('order')]);
                            });

                            selected.sort(function (a, b) {
                                return a[1] - b[1];
                            });

                            let text = '';
                            for (let i = 0; i < selected.length; i++) {
                                text += (selected[i][0] + ', ');  // without numbers
                            }

                            return text.substr(0, text.length - 2);
                        }
                    }
                });

                // show the correlation color select
                $("#divCorrelationCovars").addClass('visible').removeClass('hidden');

                let selectOptions = [];
                let html = '<select id="factorSeries" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">';
                let htmlCorrelation = '<select id="factorSeriesCorrelation" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">';
                let htmlInteractiveCovariatesLOD = `<div class="row">
                                                        <div class="col-auto align-self-center font-weight-bold">
                                                            <span>Plots</span>
                                                        </div>
                                                        <div class="col">
                                                            <select id="interactiveCovarLODS" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">
                                                    `;
                let htmlInteractiveCovariatesPeaks = `<div class="row">
                                                          <div class="col-auto align-self-center">
                                                            <span>Plot type</span>
                                                          </div>
                                                          <div class="col">
                                                              <select id="interactiveCovarPeaks" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">
                                                `;

                let htmlInteractiveCovariatesCorrelation = `<select id="interactiveCovarCorrelation" data-style="btn-secondary btn-sm" data-width="100%" class="selectpicker">`;

                global.interactiveCovariates = [];

                htmlInteractiveCovariatesLOD += `<option value="additive">Additive</option>`;
                htmlInteractiveCovariatesPeaks += `<option value="additive">Additive</option>`;
                htmlInteractiveCovariatesCorrelation += `<option value="none">None</option>`;

                $.each(ds['covar_info'], function (index, element) {
                    selectOptions.push({
                        label: element['display_name'],
                        order: index,
                        selected: element.primary,
                        title: element['display_name'],
                        value: element['sample_column'],
                    });

                    html += `<option value="${element['sample_column']}">${element['display_name']}</option>`;
                    htmlCorrelation += `<option value="${element['sample_column']}">${element['display_name']}</option>`;

                    // interactive covariates
                    if (element.interactive) {
                        global.interactiveCovariates.push(element);
                        htmlInteractiveCovariatesLOD += `<option value="${element['sample_column']}">${element['display_name']}</option>`;
                        htmlInteractiveCovariatesPeaks += `<option value="${element['sample_column']}">${element['display_name']}</option>`;
                        htmlInteractiveCovariatesCorrelation += `<option value="${element['sample_column']}">${element['display_name']}</option>`;
                    }
                });

                html += '</select>';
                htmlCorrelation += '</select>';
                htmlInteractiveCovariatesLOD += '</select></div></div>';
                htmlInteractiveCovariatesPeaks += '</select></div></div>';
                htmlInteractiveCovariatesCorrelation += '</select>';

                $('#factor-view-select').multiselect('dataprovider', selectOptions);

                $('#divFactorSeries').html(html);
                $('#divFactorSeriesCorrelation').html(htmlCorrelation);


                logDebug('global.interactiveCovariates=', global.interactiveCovariates);

                // display a selection if we have interactive covariates, nothing if not
                if (global.interactiveCovariates.length > 0) {
                    $('#divInteractiveCovariatesLOD').html(htmlInteractiveCovariatesLOD);

                    $('#interactiveCovarLODS').selectpicker();

                    $('#interactiveCovarLODS').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                        changeCovariate(e.target.value);
                    });

                    // add Covariate adjustment for correlation
                    $('#correlationCovariateSelectionText').addClass('visible').removeClass('hidden');
                    $('#correlationCovariateSelection').html(htmlInteractiveCovariatesCorrelation);
                    $('#interactiveCovarCorrelation').selectpicker();

                    $('#interactiveCovarCorrelation').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                        let selected = $(this).find(':selected').val();
                        let dataset = $('#correlationDatasetSelect').find(':selected').val();
                        switchCorrelationDataSet(dataset, selected);
                    });


                    if (resetPeaks) {
                        $('#divInteractiveCovariatesPeaks').html(htmlInteractiveCovariatesPeaks);

                        $('#interactiveCovarPeaks').selectpicker();

                        $('#interactiveCovarPeaks').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                            generateLODPeaksHTML();
                        });
                    }


                } else {
                    $('#divInteractiveCovariatesLOD').html(`<input type="hidden" id="interactiveCovarLODS" value="additive"/>`);

                    // remove Covariate adjustment for correlation
                    $('#correlationCovariateSelectionText').addClass('hidden').removeClass('visible');
                    $('#correlationCovariateSelection').html('<input type="hidden" id="interactiveCovarCorrelation" value="additive"/>');

                    if (resetPeaks) {
                        $('#divInteractiveCovariatesPeaks').html(`<input type="hidden" id="interactiveCovarPeaks" value="additive"/>`);
                    }
                }

                $('#factorSeries').selectpicker();

                $('#factorSeries').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                    if (global.currentDataset.datatype === 'mrna') {
                        plotProfile(global.geneID);
                    } else if (global.currentDataset.datatype === 'protein') {
                        plotProfile(global.proteinID);
                    } else if (global.currentDataset.datatype === 'phos') {
                        plotProfile(global.phosID);
                    } else if (global.currentDataset.datatype === 'pheno') {
                        plotProfile(global.phenotypeID);
                    } else {
                        // TODO: major error
                        logError('MAJOR ERROR');
                    }
                });

                $('#factorSeriesCorrelation').selectpicker();

                $('#factorSeriesCorrelation').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                    plotCorrelationChart();
                });

            }

            $('#btnDownloadCorrelationData').off('click');
            $('#btnDownloadCorrelationData').on('click', function(evt) {
                logDebug('Downloading correlation data');
                if (global.correlationData) {
                    let csvContent = '';
                    let id = '';

                    if (global.currentDataset.datatype === 'mrna') {
                        id = global.geneID;
                    } else if (global.currentDataset.datatype === 'protein') {
                        id = global.proteinID;
                    } else if (global.currentDataset.datatype === 'phos') {
                        id = global.phosID;
                    } else if (global.currentDataset.datatype === 'pheno') {
                        id = global.phenotypeID;
                    } else {
                        logError('MAJOR ERROR');
                    }

                    if (global.currentCorrelationDataset.datatype === 'mrna') {
                        csvContent = '"gene_id","symbol","chr","start","end","correlation"\n';
                        $.each(global.correlationData.correlations, function (k, v) {
                            csvContent += `"${v.id}","${v.symbol}","${v.chr}",${v.start},${v.end},${v.cor}\n`;
                        });
                    } else if (global.currentCorrelationDataset.datatype === 'protein') {
                        csvContent = '"gene_id","protein_id","symbol","chr","start","end","correlation"\n';
                        $.each(global.correlationData.correlations, function (k, v) {
                            csvContent += `"${v.gene_id}","${v.id}","${v.symbol}","${v.chr}",${v.start},${v.end},${v.cor}\n`;
                        });
                    } else if (global.currentCorrelationDataset.datatype === 'phos') {
                        csvContent = '"gene_id","protein_id","phos_id","symbol","chr","start","end","correlation"\n';
                        $.each(global.correlationData.correlations, function (k, v) {
                            csvContent += `"${v.gene_id}","${v.protein_id}","${v.id}","${v.symbol}","${v.chr}",${v.start},${v.end},${v.cor}\n`;
                        });
                    } else if (global.currentCorrelationDataset.datatype === 'pheno') {
                        csvContent = '"id","correlation"\n';
                        $.each(global.correlationData.correlations, function (k, v) {
                            csvContent += `"${v.id}",${v.cor}\n`;
                        });
                    } else {
                        // TODO: major error
                        logError('MAJOR ERROR');
                    }

                    downloadCSV(csvContent, `${id}_correlation.csv`, 'text/csv;encoding:utf-8');
                } else {
                    logDebug('no correlation data?');
                }
            });
        }

    
        

        function resetSecondaryPlots() {
            $('#plotMediation').html('');
            $('#allEffectPlots').html('');
            $('#plotSNPAssociation').html('');
            $('#snpWindowMenuShift').html('');
            $('#snpWindowMenu').html('');
        }

        function updateGeneSelect(groupID, submitData, geneID, proteinID, phosID, datasetID, covar) {
            // send GET request to status URL
            logDebug('update progress, calling .ajax');
            logDebug(groupID);
            logDebug("updateGeneSelect submitData=", submitData);

            if (global.runningTask) {
                let statusURL = `${statusBaseURL}${groupID}`;
                $.ajax({
                    type: 'GET',
                    url: statusURL,
                    retries: 3,
                    retryInterval: 1000,
                    success: function (data, status, request) {
                        logDebug('DATA=======', data);

                        if (data.status === 'DONE') {
                            if ('error' in data) {
                                // MAJOR ERROR
                                let message = `Unfortunately, there was a problem contacting the server.  Please try again.`;
                                stopTask();
                                showErrorMessage(message, null);
                            } else if (data.number_tasks_errors !== 0) {
                                let message = `Unfortunately, we encountered an error.  Please try again.`;
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if ('error' in value) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.error}<br>`);
                                    }
                                });

                                stopTask();
                                showErrorMessage(message, errorMessages);
                            } else if (data.number_tasks_errors === 0) {
                                // check to make sure the status codes are good
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if (value.status_code !== 200) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.response.error}<br>`);
                                    }
                                });

                                if (errorMessages !== '') {
                                    let message = `Unfortunately, there was a problem calculating the LOD SCAN.`;
                                    stopTask();
                                    showErrorMessage(message, errorMessages);
                                } else {
                                    // show result, there will be 3 datasets to get

                                    // 1. gene information
                                    global.gene = data.response_data.geneData.response;
                                    displayGeneData(global.gene.gene);
                                    let geneData = null;
                                    for (let key in global.gene.gene) {
                                        geneData = global.gene.gene[key];
                                    }

                                    // 2. LOD score information
                                    if (covar === 'additive') {
                                        global.LODChartData[covar] = data.response_data.lod.response.result;
                                        plotLODChart(data.response_data.lod.response.result, covar, null);
                                    } else {
                                        global.LODChartData.additive = data.response_data.lod.response.result;
                                        global.LODChartData[covar] = data.response_data.lodCovar.response.result;

                                        plotLODChart(data.response_data.lodCovar.response.result,
                                                     covar,
                                                     null);

                                        plotLODChart(data.response_data.lodCovar.response.result,
                                                     covar,
                                                     data.response_data.lod.response.result);
                                    }

                                    $('#interactiveCovarLODS').selectpicker('val', covar);

                                    // 3. Expression information
                                    global.expressionData = data.response_data.expression.response.result;

                                    if (global.currentDataset.datatype === 'mrna') {
                                        plotProfile(global.geneID);
                                    } else if (global.currentDataset.datatype === 'protein') {
                                        plotProfile(global.proteinID);
                                    } else if (global.currentDataset.datatype === 'phos') {
                                        plotProfile(global.phosID);
                                    } else {
                                        logDebug('ERROR');
                                    }

                                    // 4. Correlation
                                    displayCorrelation(data.response_data.correlation.response.result);

                                    // first time we need to hide jumbotron instructions
                                    // it's ok to keep hiding
                                    $('#divWelcomeMesage').html('');
                                    $('#divLOD').removeClass('invisible');
                                    $('#divItemInfo').removeClass('invisible');
                                    $('#divSecondRow').removeClass('invisible');
                                    $('#divProfileCorrelation').removeClass('invisible');
                                    stopTask();
                                }
                            }
                        }
                        else {
                            // rerun in 1 seconds
                            logDebug('Not done, keep checking...');
                            setTimeout(function () {
                                updateGeneSelect(groupID, submitData, geneID, proteinID, phosID, datasetID, covar);
                            }, 1000);
                        }
                    }
                });
            } else {
                // TODO: cleanup
                logDebug('canceling');
                let cancelURL = `${cancelBaseURL}${groupID}`;
                $.getJSON(cancelURL, function (data) {
                    logDebug(data);
                });
            }
        }

        /**
         * Perform gene search.
         */
        function selectPhenotype(phenotypeID, datasetID, covar) {
            let urlExpression = `${rBaseURL}/expression?dataset=${datasetID}&id=${phenotypeID}`;
            let urlLOD = `${rBaseURL}/lodscan?dataset=${datasetID}&id=${phenotypeID}`;
            let urlLODCovar = `${rBaseURL}/lodscan?dataset=${datasetID}&id=${phenotypeID}`;
            let urlCorrelation = `${rBaseURL}/correlation?dataset=${datasetID}&id=${phenotypeID}`;

            // TODO: make reset function
            global.gene = null;
            global.geneID = null;
            global.proteinID = null;
            global.phosID = null;
            global.phenotypeID = phenotypeID;
            global.correlationData = null;
            global.correlationDatasetID = datasetID;
            global.LODChartData = {};
            global.LODChartData.additive = null;

            // reset the covariate pickers
            configureCovarInfo(false);

            $.each(global.interactiveCovariates, function(idx, value) {
                global.LODChartData[value['column.name']] = null;
            });

            if (covar === 'additive') {
                urlLOD += '&intcovar=additive';
                urlLODCovar = null;
            } else {
                urlLOD += '&intcovar=additive';
                urlLODCovar += ('&intcovar=' + covar);
            }


            // TODO: add ncores?, regress_local? to urlLOD, or handle backend?
            //URL += '&ncores=' + _G.api_cores;
            if (rNumCores) {
                if (urlLODCovar !== null) {
                    urlLODCovar += `&cores=${rNumCores}`;
                }
                urlLOD += `&cores=${rNumCores}`;
            }

            let submitData = {
                urls:[{
                    url_id: 'expression',
                    url: urlExpression
                }, {
                    url_id: 'correlation',
                    url: urlCorrelation
                }, {
                    url_id: 'lod',
                    url: urlLOD
                }]
            };

            if (urlLODCovar !== null) {
                submitData.urls.push({
                    url_id: 'lodCovar',
                    url: urlLODCovar
                });
            }

            logDebug('submitData=', submitData);

            startTask();

            $('#div_current_item_information_header').html('');
            $('#div_current_item_information_body').html('');
            $('#lodPlotChart').html('');
            $('#lodPlotChartCovariateFull').html('');
            $('#lodPlotChartCovariateDiff').html('');

            global.chartCorrelation = null;
            $('#plotCorrelation').html('');
            $('#correlationDataTable').html('');
            $('#correlationImputation').html('');

            // The following line fires a change event which we do not want
            // $('#correlationDatasetSelect').selectpicker('val', global.datasetID);

            // Do this instead
            $('#correlationDatasetSelect').val(global.datasetID);
            $('#correlationDatasetSelect').selectpicker('render');
            $('#fact-svg-chart').html('');

            resetSecondaryPlots();

            $.ajax({
                type: 'POST',
                url: submitURL,
                contentType: 'application/json',
                data: JSON.stringify(submitData),
                retries: 3,
                retryInterval: 1000,
                success: function(data, status, request) {
                    global.runningTask = true;
                    logDebug('data=', data);
                    logDebug('status=', status);
                    logDebug('request=', request);
                    //let status_url = request.getResponseHeader('Location');
                    //logDebug('status_url=', status_url);
                    logDebug('data.group_id=', data.group_id);
                    updatePhenotypeSelect(data.group_id, datasetID, covar);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showErrorMessage(errorThrown, textStatus);
                }
            });
        }

        function updatePhenotypeSelect(groupID, datasetID, covar) {
            // send GET request to status URL
            logDebug('update progress, calling .ajax');
            logDebug(groupID);

            if (global.runningTask) {
                let statusURL = `${statusBaseURL}${groupID}`;
                $.ajax({
                    type: 'GET',
                    url: statusURL,
                    retries: 3,
                    retryInterval: 1000,
                    success: function (data, status, request) {
                        logDebug('DATA=======', data);

                        if (data.status === 'DONE') {
                            if ('error' in data) {
                                // MAJOR ERROR
                                let message = `Unfortunately, there was a problem contacting the server.  Please try again.`;
                                stopTask();
                                showErrorMessage(message, null);
                            } else if (data.number_tasks_errors !== 0) {
                                let message = `Unfortunately, we encountered an error.  Please try again.`;
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if ('error' in value) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.error}<br>`);
                                    }
                                });

                                stopTask();
                                showErrorMessage(message, errorMessages);
                            } else if (data.number_tasks_errors === 0) {
                                // check to make sure the status codes are good
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if (value.status_code !== 200) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.response.error}<br>`);
                                    }
                                });

                                if (errorMessages !== '') {
                                    let message = `Unfortunately, there was a problem calculating the LOD SCAN.`;
                                    stopTask();
                                    showErrorMessage(message, errorMessages);
                                } else {
                                    // show result, there will be 2 datasets to get
                                    displayPhenoData(global.phenotypeID);

                                    // 1. LOD score information
                                    //plotLODChart(data.response_data.lod.response.result);

                                    if (covar === 'additive') {
                                        global.LODChartData[covar] = data.response_data.lod.response.result;
                                        plotLODChart(data.response_data.lod.response.result, covar, null);
                                    } else {
                                        global.LODChartData.additive = data.response_data.lod.response.result;
                                        global.LODChartData[covar] = data.response_data.lodCovar.response.result;

                                        plotLODChart(data.response_data.lodCovar.response.result,
                                                     covar,
                                                     null);

                                        plotLODChart(data.response_data.lodCovar.response.result,
                                                     covar,
                                                     data.response_data.lod.response.result);
                                    }

                                    $('#interactiveCovarLODS').selectpicker('val', covar);

                                    // 2. Correlation
                                    displayCorrelation(data.response_data.correlation.response.result);

                                    // 3. Expression information
                                    global.expressionData = data.response_data.expression.response.result;
                                    plotProfile(global.phenotypeID);

                                    // first time we need to hide jumbotron instructions
                                    // it's ok to keep hiding
                                    $('#divWelcomeMesage').html('');
                                    $('#divLOD').removeClass('invisible');
                                    $('#divItemInfo').removeClass('invisible');
                                    $('#divSecondRow').removeClass('invisible');
                                    $('#divProfileCorrelation').removeClass('invisible');
                                    stopTask();
                                }
                            }
                        }
                        else {
                            // rerun in 1 seconds
                            logDebug('Not done, keep checking...');
                            setTimeout(function () {
                                updatePhenotypeSelect(groupID, datasetID, covar);
                            }, 1000);  // TODO: change to 1000 (1 second)
                        }
                    }
                });
            } else {
                // TODO: cleanup
                logDebug('canceling');
                let cancelURL = `${cancelBaseURL}${groupID}`;
                $.getJSON(cancelURL, function (data) {
                    logDebug(data);
                });
            }
        }

        /**
         * Perform gene search.
         */
        function selectGeneProtein(geneID, proteinID, phosID, datasetID, covar) {
            logDebug(`selectGeneProtein(${geneID}, ${proteinID}, ${phosID}, ${datasetID}, ${covar})`);

            let urlGeneData = `${window.location.protocol}//${apiURL}/api/gene/${geneID}`;
            urlGeneData += ('?release=' + global.getDataset(datasetID).ensembl_release);
            urlGeneData += ('&species=' + global.getDataset(datasetID).ensembl_species);

            let urlExpression = `${rBaseURL}/expression?dataset=${datasetID}&id=`;
            let urlLOD = `${rBaseURL}/lodscan?dataset=${datasetID}&id=`;
            let urlLODCovar = `${rBaseURL}/lodscan?dataset=${datasetID}&id=`;
            let urlCorrelation = `${rBaseURL}/correlation?dataset=${datasetID}&id=`;

            global.gene = null;
            global.geneID = geneID;
            global.proteinID = proteinID;
            global.phosID = phosID;
            global.phenotypeID = null;
            global.correlationData = null;
            global.correlationDatasetID = datasetID;
            global.LODChartData = {};
            global.LODChartData.additive = null;

            //$('#factorSeriesCorrelation').selectpicker();

            $.each(global.interactiveCovariates, function(idx, value) {
                global.LODChartData[value['column.name']] = null;
            });

            // reset the covariate pickers
            configureCovarInfo(false);

            if (global.currentDataset.datatype === 'mrna') {
                urlExpression += geneID;
                urlLOD += geneID;
                urlLODCovar += geneID;
                urlCorrelation += geneID;
            } else if (global.currentDataset.datatype === 'protein') {
                urlExpression += proteinID;
                urlLOD += proteinID;
                urlLODCovar += proteinID;
                urlCorrelation += proteinID;
            } else if (global.currentDataset.datatype === 'phos') {
                urlExpression += phosID;
                urlLOD += phosID;
                urlLODCovar += phosID;
                urlCorrelation += phosID;
            }

            if (covar === 'additive') {
                urlLOD += '&intcovar=additive';
                urlLODCovar = null;
            } else {
                urlLOD += '&intcovar=additive';
                urlLODCovar += ('&intcovar=' + covar);
            }

            // TODO: add ncores?, regress_local? to urlLOD, or handle backend?
            //URL += '&ncores=' + _G.api_cores;
            if (rNumCores) {
                if (urlLODCovar !== null) {
                    urlLODCovar += `&cores=${rNumCores}`;
                }
                urlLOD += `&cores=${rNumCores}`;
            }

            let submitData = {
                urls:[{
                    url_id: 'geneData',
                    url_description: 'Gene Data',
                    url: urlGeneData
                }, {
                    url_id: 'expression',
                    url_description: 'Expression Data',
                    url: urlExpression
                }, {
                    url_id: 'correlation',
                    url_description: 'Correlation Data',
                    url: urlCorrelation
                }, {
                    url_id: 'lod',
                    url_description: 'LOD Scan Data',
                    url: urlLOD
                }]};

            if (urlLODCovar !== null) {
                submitData.urls.push({
                    url_id: 'lodCovar',
                    url_description: 'Covariate LOD Scan Data',
                    url: urlLODCovar
                });
            }

            logDebug('submitData=', submitData);

            startTask();

            $('#div_current_item_information_header').html('');
            $('#div_current_item_information_body').html('');
            $('#lodPlotChart').html('');
            $('#lodPlotChartCovariateFull').html('');
            $('#lodPlotChartCovariateDiff').html('');

            global.chartCorrelation = null;
            $('#plotCorrelation').html('');
            $('#correlationDataTable').html('');
            $('#correlationImputation').html('');

            // The following line fires a change event which we do not want
            // $('#correlationDatasetSelect').selectpicker('val', global.datasetID);

            // Do this instead
            $('#correlationDatasetSelect').val(global.datasetID);
            $('#correlationDatasetSelect').selectpicker('render');
            $('#correlationImputation').html('');

            $('#fact-svg-chart').html('');

            resetSecondaryPlots();

            $.ajax({
                type: 'POST',
                url: submitURL,
                contentType: 'application/json',
                data: JSON.stringify(submitData),
                retries: 3,
                retryInterval: 1000,
                success: function(data, status, request) {
                    global.runningTask = true;
                    logDebug('data=', data);
                    logDebug('status=', status);
                    logDebug('request=', request);
                    logDebug('data.group_id=', data.group_id);
                    updateGeneSelect(data.group_id, submitData, geneID, proteinID, phosID, datasetID, covar);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showErrorMessage(errorThrown, textStatus);
                }
            });
        }

        function updateChangeCovariate(groupID, covar) {
            // send GET request to status URL
            logDebug('update progress, calling .ajax');

            logDebug(groupID);

            if (global.runningTask) {
                let statusURL = `${statusBaseURL}${groupID}`;
                $.ajax({
                    type: 'GET',
                    url: statusURL,
                    retries: 3,
                    retryInterval: 1000,
                    success: function (data, status, request) {
                        logDebug('DATA=======', data);

                        /* A response will be like this:

                           {
                            number_tasks_completed: 3,
                            number_tasks_errors: 2,
                            number_tasks_submitted: 3,
                            response_data: {
                                lod: {
                                    error: "Connection Error"
                                    error_message: "HTTPConnectionPool(host='myapiisawesome', port=8000): Max retries exceeded with url: /lodscan?dataset=dataset.islet.rnaseq&nCores=2&id=ENSMUSG00000023224 (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f861126ce48>: Failed to establish a new connection: [Errno -5] No address associated with hostname',))"
                                    url: "http://myapiisawesome:8000/lodscan?dataset=dataset.islet.rnaseq&nCores=2&id=ENSMUSG00000023224"
                                    url_id: "lod"
                                }
                            },
                            status: "DONE",
                            task_id: "d3c0b971-9794-4ed7-80cb-046710d2f9f5",
                            error: 'UNKNOWN ERROR'   <--- ONLY WHEN AN ERROR
                           }
                        */

                        if (data.status === 'DONE') {
                            if ('error' in data) {
                                // MAJOR ERROR
                                let message = `Unfortunately, there was a problem contacting the server.  Please try again.`;
                                stopTask();
                                showErrorMessage(message, null);
                            } else if (data.number_tasks_errors !== 0) {
                                let message = `Unfortunately, we encountered an error.  Please try again.`;
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if ('error' in value) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.error}<br>`);
                                    }
                                });

                                stopTask();
                                showErrorMessage(message, errorMessages);
                            } else if (data.number_tasks_errors === 0) {
                                // check to make sure the status codes are good
                                let errorMessages = '';
                                $.each(data.response_data, function (key, value) {
                                    if (value.status_code !== 200) {
                                        errorMessages += (`<strong>${key}:</strong> ${value.response.error}<br>`);
                                    }
                                });

                                if (errorMessages !== '') {
                                    let message = `Unfortunately, there was a problem calculating the LOD SCAN.`;
                                    stopTask();
                                    showErrorMessage(message, errorMessages);
                                } else {
                                    // show result, there will be 1
                                    global.LODChartData[covar] = data.response_data.lod.response.result;

                                    plotLODChart(data.response_data.lod.response.result,
                                                 covar,
                                                 null);

                                    plotLODChart(data.response_data.lod.response.result,
                                                 covar,
                                                 global.LODChartData.additive);

                                    stopTask();
                                }
                            }
                        }
                        else {
                            // rerun in 1 seconds
                            logDebug('Not done, keep checking...');
                            setTimeout(function () {
                                updateChangeCovariate(groupID, covar);
                            }, 1000);  // TODO: change to 1000 (1 second)
                        }
                    }
                });
            } else {
                // TODO: cleanup
                logDebug('canceling');
                let cancelURL = `${cancelBaseURL}${groupID}`;
                $.getJSON(cancelURL, function (data) {
                    logDebug(data);
                });
            }
        }

        /**
         * Change covar LOD plot.
         */
         function changeCovariate(covariate) {
            logDebug('changeCovariate(', covariate, ')');

            if (covariate === 'additive') {
                // remove all other graphs
                logDebug('additive, clear others');
                $('#lodPlotChartCovariateFull').html('');
                $('#lodPlotChartCovariateDiff').html('');
            } else {
                $('#lodPlotChart').html('');
                $('#lodPlotChartCovariateFull').html('');
                $('#lodPlotChartCovariateDiff').html('');
            }


            // check to see if we have the data, if so, plot it
            // else go get it
            if (covariate in global.LODChartData) {
                logDebug('covar in global.LODChartData, so just add it');
                if (covariate === 'additive') {
                    plotLODChart(global.LODChartData[covariate], covariate, null);
                } else {
                    plotLODChart(global.LODChartData[covariate], covariate, null);
                    plotLODChart(global.LODChartData[covariate], covariate, global.LODChartData.additive);
                }
            } else {
                logDebug('covar NOT in global.LODChartData, so go get it');
                let urlLOD = `${rBaseURL}/lodscan?dataset=${global.datasetID}&id=`;

                if (global.currentDataset.datatype === 'mrna') {
                    urlLOD += `${global.geneID}`;
                } else if (global.currentDataset.datatype === 'protein') {
                    urlLOD += `${global.proteinID}`;
                } else if (global.currentDataset.datatype === 'phos') {
                    urlLOD += `${global.phosID}`;
                } else if (global.currentDataset.datatype === 'pheno') {
                    urlLOD += `${global.phenotypeID}`;
                } else {
                    // TODO: handle error
                    logError('MAJOR PROBLEM');
                }

                urlLOD += ('&intcovar=' + covariate);

                // TODO: add ncores?, regress_local? to urlLOD, or handle backend?
                //URL += '&ncores=' + _G.api_cores;
                if (rNumCores) {
                urlLOD += `&cores=${rNumCores}`;
                }

                let submitData = {
                    urls:[{
                        url_id: 'lod',
                        url: urlLOD
                    }]};

                startTask();

                $('#fact-svg-chart').html('');

                resetSecondaryPlots();

                $.ajax({
                    type: 'POST',
                    url: submitURL,
                    contentType: 'application/json',
                    data: JSON.stringify(submitData),
                    retries: 3,
                    retryInterval: 1000,
                    success: function(data, status, request) {
                        global.runningTask = true;
                        logDebug('data=', data);
                        logDebug('status=', status);
                        logDebug('request=', request);
                        //let status_url = request.getResponseHeader('Location');
                        //logDebug('status_url=', status_url);
                        logDebug('data.group_id=', data.group_id);
                        updateChangeCovariate(data.group_id, covariate);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        showErrorMessage(errorThrown, textStatus);
                    }
                });
            }
        }

        return {
            init: init,
            findGene: findGene,
            startTask: startTask,
            stopTask: stopTask
        }
    }();

    $().ready(function () {
        QTL.init();

        // handle search
        $('#searchTerm').keypress(function(evt) {
            let code = evt.which ? evt.which : evt.keyCode;
            if (code === 13) {
                $(this).blur();
                $('#btnGo').focus().click();
            }
        });

        $('#btnGo').button().on('click', function(evt) {
            evt.preventDefault();
            let term = $('#searchTerm');
            QTL.findGene(term.val().trim().toUpperCase());
            return false;
        });

        // set some global options for Highcharts
        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: $('body').css('font-family')
                },
            },

            credits: {
                enabled: false
            },

            exporting: {
                buttons: {
                    contextButton: {
                        menuItems: [
                            'downloadPNG'
                        ]
                    }
                },
            },
        });

        $('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
           $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
        });

    });
    </script>

{% endblock %}

